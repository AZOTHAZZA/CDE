<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CalcLang è¨˜è¿°ç’°å¢ƒ (CDE) - æµ®ä¸Šã‚·ã‚§ãƒ« (L1)</title>
    <style>
        /* ã‚¹ã‚¿ã‚¤ãƒ«ã¯ç°¡æ½”åŒ–ã®ãŸã‚æœ€å°é™ã«è¨˜è¿°ã—ã¾ã™ã€‚å¿…è¦ã«å¿œã˜ã¦ä»¥å‰ã®å®Œå…¨ãªã‚¹ã‚¿ã‚¤ãƒ«ã‚’é©ç”¨ã—ã¦ãã ã•ã„ã€‚ */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #1e1e1e;
            color: #d4d4d4;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        #cde-container, #calchost-output {
            background-color: #252526;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        textarea {
            width: 100%;
            height: 300px;
            background-color: #333333;
            color: #d4d4d4;
            border: 1px solid #555555;
            padding: 10px;
            box-sizing: border-box;
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 14px;
            margin-top: 10px;
            resize: vertical;
        }
        .btn {
            background-color: #007acc;
            color: white;
            border: none;
            padding: 10px 20px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin-top: 10px;
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        .btn:hover {
            background-color: #005f99;
        }
        #audit-log-output {
            background-color: #1c1c1c;
            height: 100px;
            overflow-y: auto;
            border: 1px solid #444;
            padding: 10px;
            font-size: 12px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div id="cde-container">
        <h1 style="color: #ff9900;">CalcLang CDE æµ®ä¸Šã‚·ã‚§ãƒ« (L1)</h1>
        <p style="color: #ccc; font-size: small;">
            **ç§çš„ã§ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãªæ²ˆé»™ã®ã‚³ã‚¢ãƒ­ã‚¸ãƒƒã‚¯ (L2/L3/L4)** ã‚’å…¥åŠ›ã—ã€ãƒ­ãƒ¼ã‚«ãƒ«ç©ºé–“ã«æµ®ä¸Šã•ã›ã¾ã™ã€‚
        </p>

        <p>
            <strong>REGISTRY_CYCLE:</strong> <span id="cycle-value">0</span>
            <br>
            <strong>REGISTRY_VARS:</strong> <span id="vars-value" style="font-size: small;">{}</span>
        </p>

        <label for="calc-code" style="display: block; margin-top: 15px;">
            **L2/L3/L4 ã‚³ã‚¢ãƒ­ã‚¸ãƒƒã‚¯ (ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿)** + **ACTå…¬ç†**ã‚’å…¥åŠ›:
        </label>
        <textarea id="calc-code">
// 1. ã¾ãšã€L2/L3/L4 çµ±åˆã‚³ã‚¢ãƒ­ã‚¸ãƒƒã‚¯å®šç¾©ã‚’å…¨ã¦è²¼ã‚Šä»˜ã‘ã¾ã™ï¼ˆconst CalcOS = (function() {...})()ï¼‰ã€‚

// 2. ãã®ç›´å¾Œã«ã€ã“ã®ã‚»ãƒ‘ãƒ¬ãƒ¼ã‚¿ã‚’è¨˜è¿°ã—ã¾ã™ã€‚
// --- ACTå…¬ç† (ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›) ---

// 3. ã“ã®ä¸‹ã«ã€å®Ÿè¡Œã—ãŸã„ ACTå…¬ç† ã‚’è¨˜è¿°ã—ã¾ã™ã€‚
// ä¾‹: ACT LET ( K: "VAR_1", V: 100 ) END ACT
        </textarea>
        
        <button class="btn btn-run" onclick="executeLocalLogic()">
            â–¶ï¸ ãƒ­ãƒ¼ã‚«ãƒ«ã§å®Ÿè¡Œ (Execute in VM)
        </button>
        
        <h3 style="color: #ff5757; margin-top: 20px;">ğŸ“œ Calc-Audit Log (ç›£æŸ»è¨˜éŒ²)</h3>
        <div id="audit-log-output">
        </div>
    </div>
    
    <div id="calchost-output">
        <h2>ğŸŒ CalcHost - è«–ç†çš„æç”»é ˜åŸŸ (æµ®ä¸Šå¾…æ©Ÿä¸­)</h2>
        <div id="calchost-content">
            L1ãŒæä¾›ã™ã‚‹æç”»ã‚¨ãƒªã‚¢ã§ã™ã€‚L4ã®ACT DEPLOYå…¬ç†ã«ã‚ˆã£ã¦æ”¯é…ã•ã‚Œã‚‹ã®ã‚’å¾…ã¡ã¾ã™ã€‚
        </div>
    </div>

    <script>
        function executeLocalLogic() {
            const fullCode = document.getElementById('calc-code').value;
            
            // --- 1. L2/L3/L4ã®ãƒ­ã‚¸ãƒƒã‚¯ã¨ACTå…¬ç†ã‚’åˆ†é›¢ ---
            const separator = "// --- ACTå…¬ç† (ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›) ---";
            const parts = fullCode.split(separator);
            
            const coreLogic = parts[0]; 
            const actCode = parts[1] ? parts[1].trim() : ""; // ACTå…¬ç†éƒ¨åˆ†

            // ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°åˆæœŸåŒ–
            const $auditLogOutput = document.getElementById('audit-log-output');
            
            try {
                // --- 2. L2/L3/L4ã®ã‚³ã‚¢ãƒ­ã‚¸ãƒƒã‚¯ã‚’VMã®ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã«æµ®ä¸Šã•ã›ã‚‹ ---
                // new Function() ã‚’ä½¿ç”¨ã—ã¦ã€ã‚³ãƒ¼ãƒ‰ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã§å®Ÿè¡Œã—ã€L2/L3/L4ã‚’æµ®ä¸Šã•ã›ã‚‹
                const floatingFunction = new Function(coreLogic);
                floatingFunction(); // ã“ã‚Œã§ã‚°ãƒ­ãƒ¼ãƒãƒ«ã« CalcOS ãŒå®šç¾©ã•ã‚Œã‚‹ã“ã¨ã‚’æœŸå¾…ã™ã‚‹
                
                // --- 3. æµ®ä¸Šç¢ºèªã¨ACTå…¬ç†ã®å®Ÿè¡Œ ---
                if (typeof CalcOS !== 'undefined' && CalcOS.executeAct) {
                    // å®Ÿè¡Œå‰ã«ãƒ¬ã‚¸ã‚¹ãƒˆãƒªã‚’åˆæœŸåŒ–
                    CalcOS.init(); 
                    
                    // ACTå…¬ç†ã‚’å®Ÿè¡Œ
                    const result = CalcOS.executeAct(actCode);
                    CalcOS.updateUI(); 
                    
                    // L1ã®ç›£æŸ»ãƒ­ã‚°ã«æˆåŠŸã‚’è¨˜éŒ²
                    $auditLogOutput.innerHTML += `<div class="log-entry" style="color: yellowgreen;">[SYSTEM SUCCESS] L2/L3/L4 ã‚³ã‚¢ãƒ­ã‚¸ãƒƒã‚¯ã®æµ®ä¸Šã¨å®Ÿè¡ŒãŒå®Œäº†ã—ã¾ã—ãŸã€‚</div>`;
                    
                } else {
                    // CalcOSãŒã‚°ãƒ­ãƒ¼ãƒãƒ«ã«è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆ
                    throw new Error("L2/L3/L4ãƒ­ã‚¸ãƒƒã‚¯ã®å®Ÿè¡Œã¯æˆåŠŸã—ãŸãŒã€CalcOSã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒã‚°ãƒ­ãƒ¼ãƒãƒ«ã«è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚");
                }

            } catch (e) {
                // L1ã®ç›£æŸ»ãƒ­ã‚°ã«å¤±æ•—ã‚’è¨˜éŒ²
                if ($auditLogOutput) {
                    $auditLogOutput.innerHTML += `<div class="log-entry" style="color: red;">[SYSTEM ERROR] L1æµ®ä¸Šå¤±æ•—: ${e.message}</div>`;
                }
                console.error("L1æµ®ä¸Šå¤±æ•—:", e);
                // VMã®ã‚¨ãƒ©ãƒ¼ãŒAudit Logã«åæ˜ ã•ã‚Œã‚‹ã“ã¨ã‚’æœŸå¾…
            }
        }
        
        // èµ·å‹•æ™‚ã«UIè¦ç´ ãŒç¢ºå®Ÿã«å­˜åœ¨ã™ã‚‹ã“ã¨ã‚’ç¢ºèª
        window.onload = function() {
            const $auditLogOutput = document.getElementById('audit-log-output');
            if ($auditLogOutput) {
                $auditLogOutput.innerHTML = `<div class="log-entry" style="color: yellowgreen;">[C:0] [INIT] L1 æµ®ä¸Šã‚·ã‚§ãƒ«ãŒèµ·å‹•ã—ã¾ã—ãŸã€‚L2/L3/L4ã®æ³¨å…¥ã‚’å¾…æ©Ÿã—ã¾ã™ã€‚</div>`;
            }
        };
    </script>
</body>
</html>
