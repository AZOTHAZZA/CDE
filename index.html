<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CalcLang è¨˜è¿°ç’°å¢ƒ (CDE) - æ•°ç†çš„æ²ˆé»™ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚° v0(7) [ã‚³ã‚¢æ¤œè¨¼ãƒ¢ãƒ¼ãƒ‰]</title>
    <style>
        body {
            background-color: #1a1a2e;
            color: #ffffff;
            font-family: 'Consolas', 'Courier New', monospace;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 40px;
        }
        #cde-container {
            width: 500px;
            max-width: 90vw;
            background-color: #0d061c;
            border: 5px solid #ff9900; 
            box-shadow: 0 0 20px rgba(255, 153, 0, 0.4);
            padding: 20px;
            border-radius: 10px;
            margin-right: 20px;
        }
        textarea {
            width: 100%;
            height: 250px; 
            background-color: #1a1a2e;
            color: #d4d4d4;
            border: 1px solid #1472a3;
            padding: 10px;
            resize: none;
            font-size: 14px;
            outline: none;
            margin-bottom: 15px;
        }
        .btn {
            padding: 8px 15px;
            background-color: #ff5757;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-right: 10px;
        }
        .btn:hover {
            background-color: #ff7f7f;
        }
        .btn-run { background-color: #a47fe0; color: white;}
        .btn-run:hover { background-color: #b993f7; }

        /* CalcHost å‡ºåŠ›ã‚¨ãƒªã‚¢ã¯ç´”ç²‹ãªç™½ç´™ã®ãŸã‚å½¢å¼çš„ã«æ®‹ã™ */
        #calchost-output {
            margin-top: 30px;
            padding: 20px;
            border: 3px solid #a47fe0;
            background-color: #0d061c;
            color: #a47fe0;
            min-height: 100px;
            border-radius: 10px;
            width: 400px;
            max-width: 90vw;
            box-sizing: border-box;
            font-size: 14px;
        }
        #calchost-output h2 { color: #ffffff; border-bottom: 1px solid #a47fe0; padding-bottom: 5px;}
        
        /* ç›£æŸ»ãƒ­ã‚°ã‚¨ãƒªã‚¢ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #audit-log-output {
            margin-top: 15px;
            padding: 10px;
            border: 1px solid #c93b3b;
            background-color: #1a1a2e;
            max-height: 200px; 
            overflow-y: scroll;
            font-size: 12px;
            color: #bbb;
        }
        .log-entry {
            border-bottom: 1px dotted #333;
            padding: 3px 0;
        }
    </style>
</head>
<body>
    <div id="cde-container">
        <h1 style="color: #ff9900;">CalcLang CDE v0(7)</h1>
        <p style="color: #ccc; font-size: small;">
            **ç´”ç²‹ãªæ•°ç†çš„æ²ˆé»™ã®ãƒ¡ãƒ¢å¸³**ã‚’å®‰å®šã•ã›ã‚‹ãŸã‚ã®ã€ã‚³ã‚¢æ¤œè¨¼ãƒ¢ãƒ¼ãƒ‰ã§ã™ã€‚**<code>parseAct</code> ã®ACTãƒ˜ãƒƒãƒ€ãƒ¼è§£æã®å …ç‰¢æ€§ã‚’å¼·åŒ–ã—ã¾ã—ãŸã€‚**
        </p>

        <p>
            <strong>REGISTRY_CYCLE:</strong> <span id="cycle-value">0</span>
            <br>
            <strong>REGISTRY_VARS:</strong> <span id="vars-value" style="font-size: small;">{}</span>
        </p>

        <label for="calc-code" style="display: block; margin-top: 15px;">
            CalcLang è«–ç†è¨˜è¿° (ACTå…¬ç† - å³æ ¼ãªå®‰å®šæ€§æ¤œè¨¼ãƒ†ã‚¹ãƒˆ):
        </label>
        <textarea id="calc-code">
// --- 1. ACT LET (æ²ˆé»™ã®ç­†è¨˜å…·ãƒ†ã‚¹ãƒˆ) ---
// å¤‰æ•°åã€å€¤ã®ä¸¡ç«¯ã«ãƒã‚¤ã‚ºã¨ãªã‚‹ç©ºç™½ã‚’æ„å›³çš„ã«æŒ¿å…¥
ACT LET ( K:  VAR_1 , V:  100  )
END ACT
// æ–‡å­—åˆ—ãƒªãƒ†ãƒ©ãƒ«ã«ã‚¯ã‚©ãƒ¼ãƒˆã¨ç©ºç™½ã®ãƒã‚¤ã‚ºã‚’æŒ¿å…¥
ACT LET ( K:  VAR_2 , V: "  SUCCESS  " )
END ACT
// ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åŒºåˆ‡ã‚Šã‚«ãƒ³ãƒã®å‰å¾Œã«ãƒã‚¤ã‚ºã¨ãªã‚‹ç©ºç™½ã‚’æŒ¿å…¥
ACT LET ( K: VAR_TEST_COMMA , V: 500 )
END ACT


// --- 2. ACT CALC (æ²ˆé»™ã®æ¼”ç®—ãƒ†ã‚¹ãƒˆ) ---
// æ¼”ç®—å­ã¨ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ä¸¡ç«¯ã«ãƒã‚¤ã‚ºã¨ãªã‚‹ç©ºç™½ã‚’æ„å›³çš„ã«æŒ¿å…¥
ACT CALC ( K: VAR_3, OP:  "ADD" , V1: VAR_1 , V2:  50  )
END ACT
// å­˜åœ¨ã—ãªã„å¤‰æ•°ã‚’ä½¿ç”¨ã—ã€VMã‚¨ãƒ©ãƒ¼ã§ã¯ãªãè«–ç†çš„ãªå¤±æ•—ã‚’èª˜ç™ºã™ã‚‹ã‹ç¢ºèª
// (VMã‚¨ãƒ©ãƒ¼ã«ãªã‚‰ãšAudit Logã«ERRORãŒè¨˜éŒ²ã•ã‚Œã‚‹ã“ã¨ã‚’æœŸå¾…)
ACT CALC ( K: VAR_4, OP: "SUB", V1: VAR_1, V2: UNKNOWN_VAR )
END ACT


// --- 3. ACT STRING (æ²ˆé»™ã®é€£çµãƒ†ã‚¹ãƒˆ) ---
// æ¼”ç®—å­ã¨ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«ãƒã‚¤ã‚ºã¨ãªã‚‹ç©ºç™½ã‚’æŒ¿å…¥
ACT STRING ( K: VAR_5, OP:  "CONCAT" , V1: VAR_2, V2: " - ", V3: VAR_3 )
END ACT
// æ–‡å­—åˆ—ãƒªãƒ†ãƒ©ãƒ«ã«ä½™è¨ˆãªã‚¯ã‚©ãƒ¼ãƒˆã¨ç©ºç™½ã‚’æŒ¿å…¥
ACT STRING ( K: VAR_6, OP: "CONCAT", V1: " QUOTE " , V2: " " , V3: "  END "  )
END ACT


// --- 4. ACT IF (æ²ˆé»™ã®å¢ƒç•Œãƒ†ã‚¹ãƒˆ) ---
// æ¡ä»¶å¼å…¨ä½“ã«ãƒã‚¤ã‚ºã¨ãªã‚‹ç©ºç™½ã‚’æŒ¿å…¥
ACT IF ( CONDITION: VAR_3  ==  150 )
    ACT LET (K: STATUS_A, V: " IF_A_TRUE ")
    END ACT
END ACT
// æ–‡å­—åˆ—æ¯”è¼ƒã®å¢ƒç•Œã‚’ãƒ†ã‚¹ãƒˆï¼ˆVAR_2ã®å†…éƒ¨ç©ºç™½ã¯ç¶­æŒã•ã‚Œã‚‹ãŒã€æ¯”è¼ƒæ™‚ã«é©åˆ‡ã«å‡¦ç†ã•ã‚Œã‚‹ã‹ï¼‰
ACT IF ( CONDITION: VAR_2 == "  SUCCESS  " )
    ACT LET (K: STATUS_B, V: " IF_B_TRUE_TRIMMED ")
    END ACT
END ACT


// --- 5. ACT LOOP (æ²ˆé»™ã®åå¾©ãƒ†ã‚¹ãƒˆ) ---
// COUNTãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«ãƒã‚¤ã‚ºã¨ãªã‚‹ç©ºç™½ã‚’æŒ¿å…¥
ACT LOOP ( COUNT:  2  )
    ACT CALC (K: VAR_3, OP: "ADD", V1: VAR_3, V2: 1)
    END ACT
END ACT


// --- æœ€çµ‚çµæœç¢ºèª ---
ACT LET (K: FINAL_CHECK, V: VAR_3)
END ACT
        </textarea>
        
        <button class="btn btn-run" onclick="CalcOS.executeLogic()">
            â–¶ï¸ ä½œç‚ºã‚’ VM ã§å®Ÿè¡Œ (Execute)
        </button>
        <button class="btn btn-run" disabled style="background-color: #333;">
            ğŸ–¼ï¸ CalcHostã¸æç”» (ç„¡åŠ¹)
        </button>
        
        <h3 style="color: #ff5757; margin-top: 20px;">ğŸ“œ Calc-Audit Log (ç›£æŸ»è¨˜éŒ²)</h3>
        <div id="audit-log-output">
        </div>
    </div>
    
    <div id="calchost-output">
        <h2>ğŸŒ CalcHost - è«–ç†çš„æç”»é ˜åŸŸ (æ²ˆé»™ä¸­)</h2>
        <div id="calchost-content">
            CalcHost: æç”»å…¬ç† (ACT DEPLOY) ã¯ã€æ²ˆé»™ã®ãƒ¡ãƒ¢å¸³ã®å®‰å®šåŒ–ã®ãŸã‚ç„¡åŠ¹åŒ–ã•ã‚Œã¦ã„ã¾ã™ã€‚
        </div>
    </div>

    <script>
        // UIè¦ç´ ã®å‚ç…§
        const $code = document.getElementById('calc-code');
        const $cycleValue = document.getElementById('cycle-value');
        const $varsValue = document.getElementById('vars-value');
        const $calcHostContent = document.getElementById('calchost-content');
        const $auditLogOutput = document.getElementById('audit-log-output');

        // ğŸ§  --- Calc-OS (è«–ç†çš„ã‚ªãƒšãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ ) ã‚³ã‚¢å®šç¾© ---
        const CalcOS = (function() {
            let REGISTRY;
            const DEFAULT_REGISTRY = {
                REGISTRY_CYCLE: 0, 
                REGISTRY_VARS: {}, 
                REGISTRY_HOST_S_EXPR: null, // DEPLOYå‰Šé™¤ã«ã‚ˆã‚Šæœªä½¿ç”¨
                REGISTRY_AUDIT_LOG: [],
            };
            const COMPARISON_OPS = {
                '>': (a, b) => a > b, '<': (a, b) => a < b, '>=': (a, b) => a >= b,
                '<=': (a, b) => a <= b, '==': (a, b) => a === b, '!=': (a, b) => a !== b,
            };

            function updateUI() {
                $cycleValue.textContent = REGISTRY.REGISTRY_CYCLE;
                $varsValue.textContent = JSON.stringify(REGISTRY.REGISTRY_VARS);
                updateAuditLogUI();
            }
            
            function updateAuditLogUI() {
                $auditLogOutput.innerHTML = REGISTRY.REGISTRY_AUDIT_LOG.map(log => {
                    const color = log.type === 'SUCCESS' ? 'yellowgreen' : 'red';
                    return `<div class="log-entry" style="color: ${color};">
                        [C:${log.cycle}] [${log.type}] ${log.message}
                    </div>`;
                }).join('');
                $auditLogOutput.scrollTop = $auditLogOutput.scrollHeight;
            }

            function logAudit(type, message) {
                const entry = { type, message, cycle: REGISTRY.REGISTRY_CYCLE };
                REGISTRY.REGISTRY_AUDIT_LOG.push(entry);
                if (REGISTRY.REGISTRY_AUDIT_LOG.length > 30) {
                    REGISTRY.REGISTRY_AUDIT_LOG.shift();
                }
            }

            function init() {
                REGISTRY = JSON.parse(JSON.stringify(DEFAULT_REGISTRY));
                updateUI();
                logAudit('INIT', 'æ•°ç†çš„æ²ˆé»™ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚° v0(7) [ã‚³ã‚¢æ¤œè¨¼ãƒ¢ãƒ¼ãƒ‰]ãŒèµ·å‹•ã—ã¾ã—ãŸã€‚');
            }
            
            function parseCalcCode(code) {
                const actBlocks = [];
                const regex = /(ACT\s+\w+.*?END\s+ACT)/gs; 
                let match;
                while ((match = regex.exec(code)) !== null) {
                    actBlocks.push(match[1].trim());
                }
                return actBlocks;
            }
            
            function parseAct(actBlock) {
                // â­ ACTãƒ˜ãƒƒãƒ€ãƒ¼è§£æã®å …ç‰¢åŒ– (v0(7) ä¿®æ­£)
                const headerMatch = actBlock.match(/^ACT\s+(\w+)\s*\(\s*(.*?)\s*\)?/s);
                let actName, paramsStr, body;

                if (headerMatch) {
                    actName = headerMatch[1]; 
                    paramsStr = headerMatch[2] || ''; 
                    // bodyã®åˆ‡ã‚Šå‡ºã—ã¯ã€headerMatch[0]ï¼ˆACTãƒ˜ãƒƒãƒ€ãƒ¼å…¨ä½“ï¼‰ã®é•·ã•ã‹ã‚‰è¨ˆç®—
                    body = actBlock.substring(headerMatch[0].length, actBlock.lastIndexOf('END ACT')).trim();
                } else {
                    // ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒãªã„ACTï¼ˆä¾‹: ACT RENDER END ACTï¼‰ã®ãŸã‚ã®äºˆå‚™ãƒã‚§ãƒƒã‚¯
                    const simpleHeaderMatch = actBlock.match(/^ACT\s+(\w+)/s);
                    if (simpleHeaderMatch) {
                        actName = simpleHeaderMatch[1];
                        paramsStr = '';
                        body = actBlock.substring(simpleHeaderMatch[0].length, actBlock.lastIndexOf('END ACT')).trim();
                    } else {
                        throw new Error("ACTãƒ˜ãƒƒãƒ€æ§‹æ–‡ã‚¨ãƒ©ãƒ¼");
                    }
                }
                
                const params = {};
                // ACTã®å¼•æ•°è§£æ (v0(6)ä¿®æ­£ã‚’ç¶­æŒ)
                paramsStr.split(',').forEach(param => {
                    const paramTrimmed = param.trim();
                    if (paramTrimmed === '') return; 

                    const parts = paramTrimmed.split(':').map(p => p.trim());

                    if (parts.length === 2) {
                        params[parts[0]] = parts[1].replace(/^"|"$/g, '');
                    }
                });

                return {
                    name: actName,
                    params: params,
                    body: body,
                    fullCode: actBlock
                };
            }

            function resolveValue(keyOrLiteral) {
                const value = REGISTRY.REGISTRY_VARS[keyOrLiteral];
                
                if (value !== undefined) {
                    return value;
                }
                
                const num = Number(keyOrLiteral);
                if (!isNaN(num)) {
                    return num;
                }
                
                return keyOrLiteral;
            }

            function substituteVars(text) {
                let substitutedText = text;
                substitutedText = substitutedText.replace(/REGISTRY_CYCLE/g, REGISTRY.REGISTRY_CYCLE);

                for (const key in REGISTRY.REGISTRY_VARS) {
                    const regex = new RegExp(key, 'g'); 
                    substitutedText = substitutedText.replace(regex, REGISTRY.REGISTRY_VARS[key]);
                }
                
                return substitutedText;
            }

            function evaluateCondition(conditionStr) {
                const parts = conditionStr.match(/(\w+|\d+|".*?")\s*([<|>|<=|>=|==|!=])\s*(\w+|\d+|".*?")/);
                
                if (!parts || parts.length !== 4) {
                    throw new Error(`IFæ¡ä»¶å¼æ§‹æ–‡ã‚¨ãƒ©ãƒ¼: ${conditionStr}`);
                }

                const v1Key = parts[1].trim().replace(/^"|"$/g, ''); 
                const op = parts[2].trim();
                const v2Key = parts[3].trim().replace(/^"|"$/g, ''); 
                
                const v1 = resolveValue(v1Key);
                const v2 = resolveValue(v2Key);

                const operatorFn = COMPARISON_OPS[op];
                if (!operatorFn) {
                    throw new Error(`IFæ¡ä»¶å¼: æœªçŸ¥ã®æ¯”è¼ƒæ¼”ç®—å­ ${op}`);
                }

                if (typeof v1 === 'number' && typeof v2 === 'number') {
                    return operatorFn(v1, v2);
                } 
                
                return operatorFn(v1.toString().trim(), v2.toString().trim());
            }

            // ACT DEPLOY / RENDER é–¢é€£é–¢æ•°ã¯å‰Šé™¤

            // Calc-VM (ACTå…¬ç†å®Ÿè¡Œã‚¨ãƒ³ã‚¸ãƒ³) - å®Ÿè¡Œæœ¬ä½“
            function vmExecuteAct(act) {
                const actName = act.name;
                const actParams = act.params;

                // --- æ—¢å­˜å…¬ç†: ACT LET --- 
                if (actName === 'LET') {
                    const key = actParams.K;
                    let value = actParams.V;
                    
                    const resolvedValue = resolveValue(value);
                    
                    if (key && resolvedValue !== undefined) {
                        REGISTRY.REGISTRY_VARS[key] = resolvedValue;
                        REGISTRY.REGISTRY_CYCLE += 1;
                        logAudit('SUCCESS', `ACT LETãŒå®Œäº†: ${key} = ${resolvedValue}`);
                    } else {
                        throw new Error("K/Vãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚");
                    }
                    return "SUCCESS";
                }
                
                // --- æ—¢å­˜å…¬ç†: ACT CALC --- 
                if (actName === 'CALC') {
                    const K = actParams.K;
                    const OP = (actParams.OP || "").replace(/^"|"$/g, '').trim(); 
                    const V1 = resolveValue(actParams.V1);
                    const V2 = resolveValue(actParams.V2);
                    
                    if (typeof V1 !== 'number' || typeof V2 !== 'number') {
                         throw new Error(`CALCå¤±æ•—: V1 (${actParams.V1}) ã¾ãŸã¯ V2 (${actParams.V2}) ãŒæ•°å€¤ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚`);
                    }
                    let result;
                    switch (OP) {
                        case 'ADD': result = V1 + V2; break;
                        case 'SUB': result = V1 - V2; break;
                        case 'MUL': result = V1 * V2; break;
                        case 'DIV': 
                            if (V2 === 0) throw new Error("CALCå¤±æ•—: ã‚¼ãƒ­é™¤ç®—ã‚¨ãƒ©ãƒ¼");
                            result = V1 / V2; 
                            break;
                        default:
                            throw new Error(`CALCå¤±æ•—: æœªçŸ¥ã®æ¼”ç®—å­ ${OP}`);
                    }
                    REGISTRY.REGISTRY_VARS[K] = result;
                    REGISTRY.REGISTRY_CYCLE += 1;
                    logAudit('SUCCESS', `ACT CALCãŒå®Œäº†: ${K} = ${V1} ${OP} ${V2} = ${result}`);
                    return "SUCCESS";
                }

                // --- æ—¢å­˜å…¬ç†: ACT IF --- 
                if (actName === 'IF') {
                    const conditionStr = actParams.CONDITION;
                    let result;
                    try {
                        result = evaluateCondition(conditionStr);
                    } catch (e) {
                         logAudit('ERROR', `ACT IFæ¡ä»¶è©•ä¾¡å¤±æ•—: ${e.message}`);
                         throw new Error("IFæ¡ä»¶è©•ä¾¡å¤±æ•—");
                    }
                    
                    logAudit('AUDIT', `ACT IF: æ¡ä»¶ "${conditionStr}" ã®è©•ä¾¡çµæœã¯ ${result} ã§ã™ã€‚`);

                    if (result === true) {
                        const nestedActList = parseCalcCode(act.body);
                        for (const nestedActCode of nestedActList) {
                            const nestedAct = parseAct(nestedActCode);
                            vmExecuteAct(nestedAct);
                        }
                        logAudit('SUCCESS', 'ACT IF: æ¡ä»¶ãŒçœŸã®ãŸã‚ã€å†…éƒ¨ACTã‚’å®Ÿè¡Œã—ã¾ã—ãŸã€‚');
                    } else {
                        logAudit('AUDIT', 'ACT IF: æ¡ä»¶ãŒå½ã®ãŸã‚ã€å†…éƒ¨ACTã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸã€‚');
                    }
                    return "SUCCESS";
                }

                // --- æ—¢å­˜å…¬ç†: ACT LOOP --- 
                if (actName === 'LOOP') {
                    const count = parseInt(actParams.COUNT, 10);
                    if (isNaN(count) || count <= 0) {
                        throw new Error(`LOOPå¤±æ•—: ç„¡åŠ¹ãªã‚«ã‚¦ãƒ³ãƒˆå€¤ ${actParams.COUNT}ã€‚`);
                    }
                    const nestedActList = parseCalcCode(act.body); 
                    for (let i = 0; i < count; i++) {
                        for (const nestedActCode of nestedActList) {
                            const nestedAct = parseAct(nestedActCode);
                            vmExecuteAct(nestedAct);
                        }
                    }
                    logAudit('SUCCESS', `ACT LOOPãŒå®Œäº†ã—ã¾ã—ãŸ (${count}å›)ã€‚`);
                    return "SUCCESS";
                }
                
                // --- ACT DEPLOY/IO ã¯ã‚³ã‚¢æ¤œè¨¼ãƒ¢ãƒ¼ãƒ‰ã§ã¯å‰Šé™¤ ---
                if (actName === 'DEPLOY' || actName === 'IO') {
                    logAudit('AUDIT', `ACT ${actName} ã¯ã‚³ã‚¢æ¤œè¨¼ãƒ¢ãƒ¼ãƒ‰ã®ãŸã‚ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã¾ã—ãŸã€‚`);
                    return "SUCCESS";
                }
                
                // --- [v0(6)] å…¬ç†: ACT STRING (æ–‡å­—åˆ—æ“ä½œ) ---
                if (actName === 'STRING') {
                    const K = actParams.K;
                    const OP = (actParams.OP || "").replace(/^"|"$/g, '').trim(); 

                    if (OP === 'CONCAT') {
                        let result = "";
                        let i = 1;
                        while (actParams[`V${i}`] !== undefined) {
                            const rawVal = actParams[`V${i}`] || ""; 
                            const val = resolveValue(rawVal.replace(/^"|"$/g, '')); 
                            result += val.toString();
                            i++;
                        }
                        
                        REGISTRY.REGISTRY_VARS[K] = result;
                        REGISTRY.REGISTRY_CYCLE += 1;
                        logAudit('SUCCESS', `ACT STRING (CONCAT) ãŒå®Œäº†: ${K} = "${result}"`);
                    } else {
                        throw new Error(`STRINGå¤±æ•—: æœªçŸ¥ã®æ¼”ç®—å­ '${OP}' ã§ã™ã€‚`);
                    }
                    return "SUCCESS";
                }
                
                throw new Error(`VM: æœªçŸ¥ã®ACTå…¬ç† '${actName}' ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚`);
            }
            
            // Calc-VMã®å…¨ä½“å®Ÿè¡Œãƒ­ã‚¸ãƒƒã‚¯ 
            function executeAct(actCode) {
                let actList;
                try {
                    actList = parseCalcCode(actCode);
                } catch(e) {
                    logAudit('ERROR', `ã‚³ãƒ¼ãƒ‰è§£æã‚¨ãƒ©ãƒ¼: ${e.message}`);
                    return { status: "ERROR", reason: "PARSER_FAILURE" };
                }

                let overallStatus = "SUCCESS";
                
                for (const actBlock of actList) {
                    try {
                        const act = parseAct(actBlock);
                        vmExecuteAct(act); 
                    } catch (e) {
                        logAudit('ERROR', `ACTå®Ÿè¡Œå¤±æ•—: ${e.message} [ã‚³ãƒ¼ãƒ‰: ${actBlock.substring(0, 50)}...]`);
                        overallStatus = "ERROR";
                        break; 
                    }
                    if (overallStatus === "ERROR") break; 
                }
                
                return { status: overallStatus, reason: overallStatus === "SUCCESS" ? "ALL_ACTS_EXECUTED" : "EXECUTION_ERROR" };
            }


            return {
                init: init,
                executeLogic: function() {
                    const result = executeAct($code.value); 
                    updateUI();
                    return result;
                },
                renderHost: function() {
                    $calcHostContent.innerHTML = 'CalcHost: æç”»å…¬ç† (ACT DEPLOY) ã¯ã€æ²ˆé»™ã®ãƒ¡ãƒ¢å¸³ã®å®‰å®šåŒ–ã®ãŸã‚ç„¡åŠ¹åŒ–ã•ã‚Œã¦ã„ã¾ã™ã€‚';
                    logAudit('AUDIT', 'RENDERæ©Ÿèƒ½ã¯ã‚³ã‚¢æ¤œè¨¼ãƒ¢ãƒ¼ãƒ‰ã®ãŸã‚ç„¡åŠ¹åŒ–ã•ã‚Œã¦ã„ã¾ã™ã€‚');
                    updateUI();
                },
            };
        })();

        // èµ·å‹•
        window.onload = CalcOS.init;
    </script>
</body>
</html>
