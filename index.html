<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CalcLang è¨˜è¿°ç’°å¢ƒ (CDE) - æ•°ç†çš„æ²ˆé»™ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚° v0(4)</title>
    <style>
        body {
            background-color: #1a1a2e;
            color: #ffffff;
            font-family: 'Consolas', 'Courier New', monospace;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 40px;
        }
        #cde-container {
            width: 500px;
            max-width: 90vw;
            background-color: #0d061c;
            border: 5px solid #ff9900; 
            box-shadow: 0 0 20px rgba(255, 153, 0, 0.4);
            padding: 20px;
            border-radius: 10px;
            margin-right: 20px;
        }
        textarea {
            width: 100%;
            height: 250px; 
            background-color: #1a1a2e;
            color: #d4d4d4;
            border: 1px solid #1472a3;
            padding: 10px;
            resize: none;
            font-size: 14px;
            outline: none;
            margin-bottom: 15px;
        }
        .btn {
            padding: 8px 15px;
            background-color: #ff5757;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-right: 10px;
        }
        .btn:hover {
            background-color: #ff7f7f;
        }
        .btn-run { background-color: #a47fe0; color: white;}
        .btn-run:hover { background-color: #b993f7; }

        /* CalcHost å‡ºåŠ›ã‚¨ãƒªã‚¢ */
        #calchost-output {
            margin-top: 30px;
            padding: 20px;
            border: 3px solid #a47fe0;
            background-color: #0d061c;
            color: #a47fe0;
            min-height: 100px;
            border-radius: 10px;
            width: 400px;
            max-width: 90vw;
            box-sizing: border-box;
            font-size: 14px;
        }
        #calchost-output h2 { color: #ffffff; border-bottom: 1px solid #a47fe0; padding-bottom: 5px;}
        
        /* ç›£æŸ»ãƒ­ã‚°ã‚¨ãƒªã‚¢ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #audit-log-output {
            margin-top: 15px;
            padding: 10px;
            border: 1px solid #c93b3b;
            background-color: #1a1a2e;
            max-height: 150px;
            overflow-y: scroll;
            font-size: 12px;
            color: #bbb;
        }
        .log-entry {
            border-bottom: 1px dotted #333;
            padding: 3px 0;
        }
        /* [v9.0æ–°è¦] ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã‚¨ãƒªã‚¢ */
        #input-area {
            width: 100%;
            padding: 8px;
            margin-top: 5px;
            background-color: #2a3a4e;
            color: #d4d4d4;
            border: 1px solid #22a7f0;
            box-sizing: border-box;
        }
    </style>
</head>
<body>
    <div id="cde-container">
        <h1 style="color: #ff9900;">CalcLang CDE v0(4)</h1>
        <p style="color: #ccc; font-size: small;">
            ã‚³ã‚¢ã®å…¨ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å‡¦ç†ã«é˜²å¾¡çš„æªç½®ã‚’é©ç”¨ã—ã¾ã—ãŸã€‚
        </p>

        <p>
            <strong>REGISTRY_CYCLE:</strong> <span id="cycle-value">0</span>
            <br>
            <strong>REGISTRY_VARS:</strong> <span id="vars-value" style="font-size: small;">{}</span>
        </p>

        <label for="input-area" style="display: block; margin-top: 15px;">
            **ğŸŒ å¤–éƒ¨ãƒ‡ãƒ¼ã‚¿å…¥åŠ› (ID: input-area)**
        </label>
        <input type="text" id="input-area" value="ç™ºè¡Œ">
        
        <label for="calc-code" style="display: block; margin-top: 15px;">
            CalcLang è«–ç†è¨˜è¿° (ACTå…¬ç† - Så¼):
        </label>
        <textarea id="calc-code">
// --- âš™ï¸ I. åˆæœŸçµŒæ¸ˆãƒ»AIçŠ¶æ…‹ã®å®šç¾© ---
ACT LET (K: USER_BALANCE, V: 50)
END ACT
ACT LET (K: MINT_LIMIT, V: 100)    
END ACT
ACT LET (K: MINT_AMOUNT, V: 30)    

// AI/æ–‡è„ˆé–¢é€£ã®åˆæœŸåŒ– 
ACT LET (K: PROMPT_HISTORY, V: "ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹") 
END ACT
ACT LET (K: CONFIDENCE_SCORE, V: 0)  
END ACT
ACT LET (K: NEXT_ACTION, V: "WAIT")  
END ACT
ACT LET (K: DEDUCE_STATUS, V: "IDLE") 
END ACT
ACT LET (K: MINT_STATUS, V: "0") 

// --- ğŸ“¥ ACT IO: å¤–éƒ¨ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ ---
ACT IO (K: USER_QUERY, SRC: "input-area", MODE: "READ") 
END ACT

// --- ğŸ“ ACT STRING: AIã®æ–‡è„ˆç”Ÿæˆ ---
ACT STRING (K: FULL_CONTEXT, OP: "CONCAT", V1: PROMPT_HISTORY, V2: " " , V3: USER_QUERY)
END ACT

// ===============================================
// ğŸ§  II. AIæ¨è«–ãƒ­ã‚¸ãƒƒã‚¯ (æ“¬ä¼¼ ACT DEDUCE)
// ===============================================

// --- 1. æ¨è«–è¨ˆç®— --- (ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ãŒ "ç™ºè¡Œ" ã®å ´åˆ)
ACT IF (CONDITION: USER_QUERY == "ç™ºè¡Œ") 
    
    ACT CALC (K: CONFIDENCE_SCORE, OP: "ADD", V1: CONFIDENCE_SCORE, V2: 0.9)
    END ACT
    
    ACT LET (K: NEXT_ACTION, V: "MINT")
    END ACT
    
    ACT LET (K: DEDUCE_STATUS, V: "APPROVED") 
    END ACT
END ACT


// --- 2. æš´èµ°æŠ‘æ­¢ (AIå´ã®æœ€çµ‚ãƒã‚§ãƒƒã‚¯) ---
ACT IF (CONDITION: CONFIDENCE_SCORE < 0.5)
    ACT LET (K: NEXT_ACTION, V: "WAIT") 
    END ACT
    ACT LET (K: DEDUCE_STATUS, V: "REJECTED") 
    END ACT
END ACT

// ===============================================
// ğŸ’° III. çµŒæ¸ˆä½œç”¨å®Ÿè¡Œãƒ­ã‚¸ãƒƒã‚¯ (æ“¬ä¼¼ ACT MINT)
// ===============================================

// --- 3. AIææ¡ˆã®æ‰¿èª ---
ACT IF (CONDITION: NEXT_ACTION == "MINT")

    // a. ç™ºè¡Œå¾Œã®æ®‹é«˜ã‚’è¨ˆç®— (50 + 30 = 80)
    ACT CALC (K: NEW_BALANCE, OP: "ADD", V1: USER_BALANCE, V2: MINT_AMOUNT)
    END ACT

    // b. æš´èµ°æŠ‘æ­¢ãƒã‚§ãƒƒã‚¯ (ä¸Šé™è¶…éãªã—ã®ç¢ºèª: 80 < 100 -> TRUE)
    ACT IF (CONDITION: NEW_BALANCE < MINT_LIMIT)
        
        ACT LET (K: USER_BALANCE, V: NEW_BALANCE) 
        END ACT
        ACT LET (K: MINT_STATUS, V: "1") 
        END ACT
        
    END ACT
    ACT IF (CONDITION: NEW_BALANCE >= MINT_LIMIT)
        ACT LET (K: MINT_STATUS, V: "-1") 
        END ACT
        ACT LET (K: DEDUCE_STATUS, V: "BLOCKED") 
        END ACT
    END ACT
END ACT

// ===============================================
// ğŸ–¼ï¸ IV. æœ€çµ‚çš„ãªç›£æŸ»çµæœã®æç”»
// ===============================================
ACT DEPLOY
    ['div', {'style': 'padding: 15px; background-color: #0c0b43; border-radius: 5px; border: 1px solid #22a7f0;'}, [
        ['h3', {'style': 'color': '#fff;'}, ['âœ… è‡ªå¾‹çµŒæ¸ˆã‚·ã‚¹ãƒ†ãƒ  (AES) ç›£æŸ»å ±å‘Š']],
        ['p', {'style': 'border-bottom: 1px dotted #444; padding-bottom: 5px;'}, ['ğŸ”„ æœ€çµ‚ã‚µã‚¤ã‚¯ãƒ«', REGISTRY_CYCLE]],
        ['p', {'style': 'color': '#22a7f0;'}, ['ğŸ“ AIæ–‡è„ˆ', FULL_CONTEXT]],
        ['p', {'style': 'color': '#f0f090;'}, ['ğŸ§  AIææ¡ˆã‚¢ã‚¯ã‚·ãƒ§ãƒ³', NEXT_ACTION]],
        ['p', {'style': 'color': '#90f090;'}, ['AIç›£æŸ»ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹', DEDUCE_STATUS]],
        ['p', {'style': 'color': '#90f090;'}, ['çµŒæ¸ˆç›£æŸ»ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹', MINT_STATUS, ' (1=æˆåŠŸ)']],
        ['p', {'style': 'color': '#fff; font-weight: bold; margin-top: 10px;'}, ['ğŸ’° æœ€çµ‚æ®‹é«˜', USER_BALANCE]],
        ['p', {}, ['MINTä¸Šé™', MINT_LIMIT]]
    ]]
END ACT
        </textarea>
        
        <button class="btn btn-run" onclick="CalcOS.executeLogic()">
            â–¶ï¸ ä½œç‚ºã‚’ VM ã§å®Ÿè¡Œ (Execute)
        </button>
        <button class="btn btn-run" onclick="CalcOS.renderHost()">
            ğŸ–¼ï¸ CalcHostã¸æç”» (ACT RENDER)
        </button>
        
        <h3 style="color: #ff5757; margin-top: 20px;">ğŸ“œ Calc-Audit Log (ç›£æŸ»è¨˜éŒ²)</h3>
        <div id="audit-log-output">
        </div>
    </div>
    
    <div id="calchost-output">
        <h2>ğŸŒ CalcHost - è«–ç†çš„æç”»é ˜åŸŸ</h2>
        <div id="calchost-content">
            CalcHostã®åˆæœŸæ²ˆé»™çŠ¶æ…‹... (ACT RENDERã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„)
        </div>
    </div>

    <script>
        // UIè¦ç´ ã®å‚ç…§
        const $code = document.getElementById('calc-code');
        const $cycleValue = document.getElementById('cycle-value');
        const $varsValue = document.getElementById('vars-value');
        const $calcHostContent = document.getElementById('calchost-content');
        const $auditLogOutput = document.getElementById('audit-log-output');

        // ğŸ§  --- Calc-OS (è«–ç†çš„ã‚ªãƒšãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ ) ã‚³ã‚¢å®šç¾© ---
        const CalcOS = (function() {
            let REGISTRY;
            const DEFAULT_REGISTRY = {
                REGISTRY_CYCLE: 0, 
                REGISTRY_VARS: {}, 
                REGISTRY_HOST_S_EXPR: null, 
                REGISTRY_AUDIT_LOG: [],
            };
            const COMPARISON_OPS = {
                '>': (a, b) => a > b, '<': (a, b) => a < b, '>=': (a, b) => a >= b,
                '<=': (a, b) => a <= b, '==': (a, b) => a === b, '!=': (a, b) => a !== b,
            };

            function updateUI() {
                $cycleValue.textContent = REGISTRY.REGISTRY_CYCLE;
                $varsValue.textContent = JSON.stringify(REGISTRY.REGISTRY_VARS);
                updateAuditLogUI();
            }
            
            function updateAuditLogUI() {
                $auditLogOutput.innerHTML = REGISTRY.REGISTRY_AUDIT_LOG.map(log => {
                    const color = log.type === 'SUCCESS' ? 'yellowgreen' : 'red';
                    return `<div class="log-entry" style="color: ${color};">
                        [C:${log.cycle}] [${log.type}] ${log.message}
                    </div>`;
                }).join('');
                $auditLogOutput.scrollTop = $auditLogOutput.scrollHeight;
            }

            function logAudit(type, message) {
                const entry = { type, message, cycle: REGISTRY.REGISTRY_CYCLE };
                REGISTRY.REGISTRY_AUDIT_LOG.push(entry);
                if (REGISTRY.REGISTRY_AUDIT_LOG.length > 30) {
                    REGISTRY.REGISTRY_AUDIT_LOG.shift();
                }
            }

            function init() {
                REGISTRY = JSON.parse(JSON.stringify(DEFAULT_REGISTRY));
                updateUI();
                logAudit('INIT', 'æ•°ç†çš„æ²ˆé»™ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚° v0(4)ãŒèµ·å‹•ã—ã¾ã—ãŸã€‚');
            }
            
            function parseCalcCode(code) {
                const actBlocks = [];
                const regex = /(ACT\s+\w+.*?END\s+ACT)/gs; 
                let match;
                while ((match = regex.exec(code)) !== null) {
                    actBlocks.push(match[1].trim());
                }
                return actBlocks;
            }
            
            function parseAct(actBlock) {
                const headerMatch = actBlock.match(/^ACT\s+(\w+)\s*(?:\((.*?)\))?/s);
                let actName, paramsStr, body;

                if (headerMatch) {
                    actName = headerMatch[1]; 
                    paramsStr = headerMatch[2] || ''; 
                    body = actBlock.substring(headerMatch[0].length, actBlock.lastIndexOf('END ACT')).trim();
                } else {
                    const bodyMatch = actBlock.match(/^ACT\s+(\w+)(.*?END\s+ACT)/s);
                    if (bodyMatch) {
                        actName = bodyMatch[1];
                        paramsStr = '';
                        body = bodyMatch[2].trim().replace(/END\s+ACT$/, '').trim();
                    } else {
                        throw new Error("ACTãƒ˜ãƒƒãƒ€æ§‹æ–‡ã‚¨ãƒ©ãƒ¼");
                    }
                }
                
                const params = {};
                // ACTã®å¼•æ•°è§£æ
                paramsStr.split(',').forEach(param => {
                    const parts = param.trim().split(':').map(p => p.trim());
                    if (parts.length === 2) {
                        // Vã®å€¤ã‚’è§£æã™ã‚‹éš›ã«ã€å‰å¾Œã®ã‚¯ã‚©ãƒ¼ãƒˆã®ã¿ã‚’é™¤å»ã—ã€å†…éƒ¨ã®ãƒ‡ãƒªãƒŸã‚¿èª¤èªã‚’å›é¿
                        params[parts[0]] = parts[1].replace(/^"|"$/g, '');
                    }
                });

                return {
                    name: actName,
                    params: params,
                    body: body,
                    fullCode: actBlock
                };
            }

            function resolveValue(keyOrLiteral) {
                const value = REGISTRY.REGISTRY_VARS[keyOrLiteral];
                
                if (value !== undefined) {
                    return value;
                }
                
                const num = Number(keyOrLiteral);
                if (!isNaN(num)) {
                    return num;
                }
                
                // â­ æ–‡å­—åˆ—ãƒªãƒ†ãƒ©ãƒ«ã‚’è¿”ã™
                return keyOrLiteral;
            }

            function substituteVars(text) {
                let substitutedText = text;
                substitutedText = substitutedText.replace(/REGISTRY_CYCLE/g, REGISTRY.REGISTRY_CYCLE);

                for (const key in REGISTRY.REGISTRY_VARS) {
                    const regex = new RegExp(key, 'g'); 
                    substitutedText = substitutedText.replace(regex, REGISTRY.REGISTRY_VARS[key]);
                }
                
                return substitutedText;
            }

            function evaluateCondition(conditionStr) {
                const parts = conditionStr.match(/(\w+|\d+|".*?")\s*([<|>|<=|>=|==|!=])\s*(\w+|\d+|".*?")/);
                
                if (!parts || parts.length !== 4) {
                    throw new Error(`IFæ¡ä»¶å¼æ§‹æ–‡ã‚¨ãƒ©ãƒ¼: ${conditionStr}`);
                }

                const v1Key = parts[1].trim().replace(/^"|"$/g, ''); 
                const op = parts[2].trim();
                const v2Key = parts[3].trim().replace(/^"|"$/g, ''); 
                
                const v1 = resolveValue(v1Key);
                const v2 = resolveValue(v2Key);

                const operatorFn = COMPARISON_OPS[op];
                if (!operatorFn) {
                    throw new Error(`IFæ¡ä»¶å¼: æœªçŸ¥ã®æ¯”è¼ƒæ¼”ç®—å­ ${op}`);
                }

                if (typeof v1 === 'number' && typeof v2 === 'number') {
                    return operatorFn(v1, v2);
                } 
                
                return operatorFn(v1.toString(), v2.toString());
            }

            function renderSExpr(sExpr) {
                if (typeof sExpr === 'string') {
                    return document.createTextNode(substituteVars(sExpr));
                }
                
                const [tagName, attributes, childrenArray] = sExpr;
                const children = Array.isArray(childrenArray) ? childrenArray : [];
                
                if (typeof tagName !== 'string' || typeof attributes !== 'object') {
                    throw new Error(`Invalid S-Expr header: ${tagName}, ${attributes}`);
                }

                const element = document.createElement(tagName);

                for (const key in attributes) {
                    if (attributes.hasOwnProperty(key)) {
                        element.setAttribute(key, substituteVars(attributes[key]));
                    }
                }

                for (const child of children) {
                    element.appendChild(renderSExpr(child));
                }

                return element;
            }


            // Calc-VM (ACTå…¬ç†å®Ÿè¡Œã‚¨ãƒ³ã‚¸ãƒ³) - å®Ÿè¡Œæœ¬ä½“
            function vmExecuteAct(act) {
                const actName = act.name;
                const actParams = act.params;

                // --- æ—¢å­˜å…¬ç†: ACT LET --- 
                if (actName === 'LET') {
                    const key = actParams.K;
                    let value = actParams.V;
                    
                    const resolvedValue = resolveValue(value);
                    
                    if (key && resolvedValue !== undefined) {
                        REGISTRY.REGISTRY_VARS[key] = resolvedValue;
                        REGISTRY.REGISTRY_CYCLE += 1;
                        logAudit('SUCCESS', `ACT LETãŒå®Œäº†: ${key} = ${resolvedValue}`);
                    } else {
                        throw new Error("K/Vãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚");
                    }
                    return "SUCCESS";
                }
                
                // --- æ—¢å­˜å…¬ç†: ACT CALC --- 
                if (actName === 'CALC') {
                    const K = actParams.K;
                    // â­ .trim()ã‚’è¿½åŠ 
                    const OP = (actParams.OP || "").replace(/^"|"$/g, '').trim(); 
                    const V1 = resolveValue(actParams.V1);
                    const V2 = resolveValue(actParams.V2);
                    if (typeof V1 !== 'number' || typeof V2 !== 'number') {
                         throw new Error(`CALCå¤±æ•—: V1 (${actParams.V1}) ã¾ãŸã¯ V2 (${actParams.V2}) ãŒæ•°å€¤ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚`);
                    }
                    let result;
                    switch (OP) {
                        case 'ADD': result = V1 + V2; break;
                        case 'SUB': result = V1 - V2; break;
                        case 'MUL': result = V1 * V2; break;
                        case 'DIV': 
                            if (V2 === 0) throw new Error("CALCå¤±æ•—: ã‚¼ãƒ­é™¤ç®—ã‚¨ãƒ©ãƒ¼");
                            result = V1 / V2; 
                            break;
                        default:
                            throw new Error(`CALCå¤±æ•—: æœªçŸ¥ã®æ¼”ç®—å­ ${OP}`);
                    }
                    REGISTRY.REGISTRY_VARS[K] = result;
                    REGISTRY.REGISTRY_CYCLE += 1;
                    logAudit('SUCCESS', `ACT CALCãŒå®Œäº†: ${K} = ${V1} ${OP} ${V2} = ${result}`);
                    return "SUCCESS";
                }

                // --- æ—¢å­˜å…¬ç†: ACT IF --- 
                if (actName === 'IF') {
                    const conditionStr = actParams.CONDITION;
                    let result;
                    try {
                        result = evaluateCondition(conditionStr);
                    } catch (e) {
                         logAudit('ERROR', `ACT IFæ¡ä»¶è©•ä¾¡å¤±æ•—: ${e.message}`);
                         throw new Error("IFæ¡ä»¶è©•ä¾¡å¤±æ•—");
                    }
                    
                    logAudit('AUDIT', `ACT IF: æ¡ä»¶ "${conditionStr}" ã®è©•ä¾¡çµæœã¯ ${result} ã§ã™ã€‚`);

                    if (result === true) {
                        const nestedActList = parseCalcCode(act.body);
                        for (const nestedActCode of nestedActList) {
                            const nestedAct = parseAct(nestedActCode);
                            vmExecuteAct(nestedAct);
                        }
                        logAudit('SUCCESS', 'ACT IF: æ¡ä»¶ãŒçœŸã®ãŸã‚ã€å†…éƒ¨ACTã‚’å®Ÿè¡Œã—ã¾ã—ãŸã€‚');
                    } else {
                        logAudit('AUDIT', 'ACT IF: æ¡ä»¶ãŒå½ã®ãŸã‚ã€å†…éƒ¨ACTã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸã€‚');
                    }
                    return "SUCCESS";
                }

                // --- æ—¢å­˜å…¬ç†: ACT LOOP --- 
                if (actName === 'LOOP') {
                    const count = parseInt(actParams.COUNT, 10);
                    if (isNaN(count) || count <= 0) {
                        throw new Error(`LOOPå¤±æ•—: ç„¡åŠ¹ãªã‚«ã‚¦ãƒ³ãƒˆå€¤ ${actParams.COUNT}ã€‚`);
                    }
                    const nestedActList = parseCalcCode(act.body); 
                    for (let i = 0; i < count; i++) {
                        for (const nestedActCode of nestedActList) {
                            const nestedAct = parseAct(nestedActCode);
                            vmExecuteAct(nestedAct);
                        }
                    }
                    logAudit('SUCCESS', `ACT LOOPãŒå®Œäº†ã—ã¾ã—ãŸ (${count}å›)ã€‚`);
                    return "SUCCESS";
                }
                
                // --- æ—¢å­˜å…¬ç†: ACT DEPLOY --- 
                if (actName === 'DEPLOY') {
                    try {
                        const parsedSExpr = JSON.parse(act.body); 
                        REGISTRY.REGISTRY_HOST_S_EXPR = parsedSExpr; 
                        REGISTRY.REGISTRY_CYCLE += 1;
                        logAudit('SUCCESS', 'ACT DEPLOYãŒå®Œäº†ã€‚Så¼ãŒREGISTRYã«æ ¼ç´ã•ã‚Œã¾ã—ãŸã€‚');
                    } catch (e) {
                        logAudit('ERROR', `DEPLOYå¤±æ•—: Så¼ãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼: ${e.message}`);
                        throw new Error("DEPLOYå¤±æ•—");
                    }
                    return "SUCCESS";
                }

                // --- [v0(4) ä¿®æ­£] å…¬ç†: ACT IO (å…¥å‡ºåŠ›) ---
                if (actName === 'IO') {
                    const key = actParams.K;
                    // â­ æ±ºå®šç‰ˆä¿®æ­£: SRCã¨MODEã«.trim()ã‚’è¿½åŠ ã—ã¦å‰å¾Œã®ç©ºç™½ã‚’å‰Šé™¤
                    const sourceId = (actParams.SRC || "").replace(/^"|"$/g, '').trim(); 
                    const mode = (actParams.MODE || "READ").replace(/^"|"$/g, '').trim();

                    if (mode === 'READ') {
                        const sourceElement = document.getElementById(sourceId);
                        if (!sourceElement) {
                            throw new Error(`IOå¤±æ•—: å‚ç…§ID '${sourceId}' ã®è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚`);
                        }
                        const value = sourceElement.value;
                        REGISTRY.REGISTRY_VARS[key] = value;
                        REGISTRY.REGISTRY_CYCLE += 1;
                        logAudit('SUCCESS', `ACT IO (READ) ãŒå®Œäº†: ${key} <- "${value}" (from #${sourceId})`);
                    } else {
                        throw new Error(`IOå¤±æ•—: æœªçŸ¥ã®ãƒ¢ãƒ¼ãƒ‰ '${mode}' ã§ã™ã€‚`);
                    }
                    return "SUCCESS";
                }
                
                // --- [v0(4) ä¿®æ­£] å…¬ç†: ACT STRING (æ–‡å­—åˆ—æ“ä½œ) ---
                if (actName === 'STRING') {
                    const K = actParams.K;
                    // â­ æ±ºå®šç‰ˆä¿®æ­£: OPã«.trim()ã‚’è¿½åŠ ã—ã¦å‰å¾Œã®ç©ºç™½ã‚’å‰Šé™¤
                    const OP = (actParams.OP || "").replace(/^"|"$/g, '').trim(); 

                    if (OP === 'CONCAT') {
                        let result = "";
                        let i = 1;
                        while (actParams[`V${i}`] !== undefined) {
                            const rawVal = actParams[`V${i}`] || ""; 
                            const val = resolveValue(rawVal.replace(/^"|"$/g, ''));
                            result += val.toString();
                            i++;
                        }
                        
                        REGISTRY.REGISTRY_VARS[K] = result;
                        REGISTRY.REGISTRY_CYCLE += 1;
                        logAudit('SUCCESS', `ACT STRING (CONCAT) ãŒå®Œäº†: ${K} = "${result}"`);
                    } else {
                        throw new Error(`STRINGå¤±æ•—: æœªçŸ¥ã®æ¼”ç®—å­ '${OP}' ã§ã™ã€‚`);
                    }
                    return "SUCCESS";
                }
                
                throw new Error(`VM: æœªçŸ¥ã®ACTå…¬ç† '${actName}' ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚`);
            }
            
            // Calc-VMã®å…¨ä½“å®Ÿè¡Œãƒ­ã‚¸ãƒƒã‚¯ 
            function executeAct(actCode) {
                let actList;
                try {
                    actList = parseCalcCode(actCode);
                } catch(e) {
                    logAudit('ERROR', `ã‚³ãƒ¼ãƒ‰è§£æã‚¨ãƒ©ãƒ¼: ${e.message}`);
                    return { status: "ERROR", reason: "PARSER_FAILURE" };
                }

                let overallStatus = "SUCCESS";
                
                for (const actBlock of actList) {
                    try {
                        const act = parseAct(actBlock);
                        vmExecuteAct(act); 
                    } catch (e) {
                        logAudit('ERROR', `ACTå®Ÿè¡Œå¤±æ•—: ${e.message} [ã‚³ãƒ¼ãƒ‰: ${actBlock.substring(0, 50)}...]`);
                        overallStatus = "ERROR";
                        break; 
                    }
                }
                
                return { status: overallStatus, reason: overallStatus === "SUCCESS" ? "ALL_ACTS_EXECUTED" : "EXECUTION_ERROR" };
            }


            return {
                init: init,
                executeLogic: function() {
                    const result = executeAct($code.value); 
                    updateUI();
                    return result;
                },
                renderHost: function() {
                    $calcHostContent.innerHTML = ''; 
                    
                    const sExpr = REGISTRY.REGISTRY_HOST_S_EXPR;

                    if (!sExpr) {
                        $calcHostContent.innerHTML = 'CalcHost: DEPLOYãŒå®Ÿè¡Œã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚';
                        return;
                    }

                    try {
                        const renderedElement = renderSExpr(sExpr);
                        $calcHostContent.appendChild(renderedElement); 
                        logAudit('RENDER', 'CalcHostã¸ã®Så¼æç”» (ACT RENDER) ã‚’å®Ÿè¡Œã—ã¾ã—ãŸã€‚');
                    } catch (e) {
                        logAudit('ERROR', `ACT RENDERå¤±æ•—: æç”»ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ: ${e.message}`);
                        $calcHostContent.innerHTML = `<p style="color: red; padding: 10px;">RENDER ERROR: ${e.message}</p>`;
                    }
                    updateUI();
                },
            };
        })();

        // èµ·å‹•
        window.onload = CalcOS.init;
    </script>
</body>
</html>
