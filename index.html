<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CalcLang 記述環境 (CDE) - 浮上シェル (L1)</title>
    <style>
        /* スタイルは簡潔化のため省略しますが、以前のものを適用してください */
        body { /* ... */ }
        #cde-container { /* ... */ }
        textarea { /* ... */ }
        .btn { /* ... */ }
        #calchost-output { /* ... */ }
        #audit-log-output { /* ... */ }
    </style>
</head>
<body>
    <div id="cde-container">
        <h1 style="color: #ff9900;">CalcLang CDE 浮上シェル (L1)</h1>
        <p style="color: #ccc; font-size: small;">
            **私的でプライベートな沈黙のコアロジック (L2/L3/L4)** を入力し、ローカル空間に浮上させます。
        </p>

        <p>
            <strong>REGISTRY_CYCLE:</strong> <span id="cycle-value">0</span>
            <br>
            <strong>REGISTRY_VARS:</strong> <span id="vars-value" style="font-size: small;">{}</span>
        </p>

        <label for="calc-code" style="display: block; margin-top: 15px;">
            **L2/L3/L4 コアロジック (ユーザーのローカルデータ)** + **ACT公理**を入力:
        </label>
        <textarea id="calc-code">
// ここにユーザーがローカルに持つL2/L3/L4のコード（CalcOSの定義）を貼り付け、
// その直後に実行したいACT公理を記述します。
// 例:
// const CalcOS = (function() { ...L2/L3/L4ロジック... })();
// CalcOS.executeLogic = function() { ... }
// ...ACT公理...
        </textarea>
        
        <button class="btn btn-run" onclick="executeLocalLogic()">
            ▶️ ローカルで実行 (Execute in VM)
        </button>
        
        <h3 style="color: #ff5757; margin-top: 20px;">📜 Calc-Audit Log (監査記録)</h3>
        <div id="audit-log-output">
        </div>
    </div>
    
    <div id="calchost-output">
        <h2>🌐 CalcHost - 論理的描画領域 (浮上待機中)</h2>
        <div id="calchost-content">
            L1が提供する描画エリアです。L4のACT DEPLOY公理によって支配されるのを待ちます。
        </div>
    </div>

    <script>
        function executeLocalLogic() {
            const code = document.getElementById('calc-code').value;
            try {
                // VMのメモリ空間で入力された文字列を直接プログラムとして実行
                // これにより、L2/L3/L4の論理がローカルに浮上する
                eval(code); 
                
                // L2/L3/L4のロジックが実行され、CalcOSというグローバルオブジェクトが定義されたと仮定し、
                // その後、CalcOSの実行ロジックを呼び出す必要があります。
                // 
                // しかし、この方法だと、コアロジックとACT公理を分離して入力できないため、
                // コアロジックの定義（L2/L3/L4）とACT公理（ユーザーの入力）を分けて実行する必要があります。
                
                // --- 暫定的な実行ロジック（L2/L3/L4のロジックがCalcOSという関数を定義することを前提） ---
                
                // L2/L3/L4の定義部分を実行
                const logicPart = code.substring(0, code.indexOf('// ---')); // ACT公理の手前まで
                eval(logicPart);

                // ACT公理の部分を実行
                const actCodePart = code.substring(code.indexOf('// ---'));
                if (typeof CalcOS !== 'undefined' && CalcOS.executeAct) {
                    CalcOS.executeAct(actCodePart);
                    CalcOS.updateUI(); // L4に組み込まれているはずのUI更新関数を呼び出し
                } else {
                    alert("L2/L3/L4のロジックが正常に浮上できませんでした (CalcOS未定義)。");
                }

            } catch (e) {
                const $auditLogOutput = document.getElementById('audit-log-output');
                $auditLogOutput.innerHTML += `<div class="log-entry" style="color: red;">[SYSTEM ERROR] L1浮上失敗: ${e.message}</div>`;
                console.error("L1浮上失敗:", e);
            }
        }
        
        // 起動時にUI要素が確実に存在することを確認
        window.onload = function() {
            const $auditLogOutput = document.getElementById('audit-log-output');
            $auditLogOutput.innerHTML = `<div class="log-entry" style="color: yellowgreen;">[C:0] [INIT] L1 浮上シェルが起動しました。L2/L3/L4の注入を待機します。</div>`;
        };
    </script>
</body>
</html>
