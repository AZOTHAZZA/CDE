
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CalcLang è¨˜è¿°ç’°å¢ƒ (CDE) - æ•°ç†çš„æ²ˆé»™ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚° v8.0 (æ¡ä»¶åˆ†å²)</title>
    <style>
        body {
            background-color: #1a1a2e;
            color: #ffffff;
            font-family: 'Consolas', 'Courier New', monospace;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 40px;
        }
        #cde-container {
            width: 500px;
            max-width: 90vw;
            background-color: #0d061c;
            border: 5px solid #ff5757; /* åˆ¶å¾¡æ§‹é€ ã®ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼ */
            box-shadow: 0 0 20px rgba(255, 87, 87, 0.4);
            padding: 20px;
            border-radius: 10px;
            margin-right: 20px;
        }
        textarea {
            width: 100%;
            height: 250px; 
            background-color: #1a1a2e;
            color: #d4d4d4;
            border: 1px solid #c93b3b;
            padding: 10px;
            resize: none;
            font-size: 14px;
            outline: none;
            margin-bottom: 15px;
        }
        .btn {
            padding: 8px 15px;
            background-color: #ff5757;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-right: 10px;
        }
        .btn:hover {
            background-color: #ff7f7f;
        }
        .btn-run { background-color: #a47fe0; color: white;}
        .btn-run:hover { background-color: #b993f7; }

        /* CalcHost å‡ºåŠ›ã‚¨ãƒªã‚¢ */
        #calchost-output {
            margin-top: 30px;
            padding: 20px;
            border: 3px solid #a47fe0;
            background-color: #0d061c;
            color: #a47fe0;
            min-height: 100px;
            border-radius: 10px;
            width: 400px;
            max-width: 90vw;
            box-sizing: border-box;
            font-size: 14px;
        }
        #calchost-content h1, h2, h3 { color: #fff; }
        #calchost-output h2 { color: #ffffff; border-bottom: 1px solid #a47fe0; padding-bottom: 5px;}
        
        /* ç›£æŸ»ãƒ­ã‚°ã‚¨ãƒªã‚¢ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #audit-log-output {
            margin-top: 15px;
            padding: 10px;
            border: 1px solid #c93b3b;
            background-color: #1a1a2e;
            max-height: 150px;
            overflow-y: scroll;
            font-size: 12px;
            color: #bbb;
        }
        .log-entry {
            border-bottom: 1px dotted #333;
            padding: 3px 0;
        }
    </style>
</head>
<body>
    <div id="cde-container">
        <h1 style="color: #ff5757;">CalcLang CDE v8.0 (æ¡ä»¶åˆ†å²)</h1>
        <p style="color: #ccc; font-size: small;">
            æ¡ä»¶åˆ†å² (ACT IF) ã‚’å°å…¥ã€‚è¨ˆç®—çµæœã«åŸºã¥ãè«–ç†çš„ãªé¸æŠã‚’å¯èƒ½ã«ã€‚
        </p>

        <p>
            <strong>REGISTRY_CYCLE:</strong> <span id="cycle-value">0</span>
            <br>
            <strong>REGISTRY_VARS:</strong> <span id="vars-value" style="font-size: small;">{}</span>
        </p>
        
        <label for="calc-code" style="display: block; margin-top: 15px;">
            CalcLang è«–ç†è¨˜è¿° (ACTå…¬ç† - Så¼):
        </label>
        <textarea id="calc-code">
// --- âš™ï¸ åˆæœŸè¨­å®š ---
ACT LET (K: ALPHA_BALANCE, V: 50)
END ACT
ACT LET (K: STATUS_MESSAGE, V: "åˆæœŸçŠ¶æ…‹")
END ACT

// --- â“ ACT IF: æ¡ä»¶åˆ†å²ã®å®Ÿè¡Œ ---
// çµŒæ¸ˆãƒ­ã‚¸ãƒƒã‚¯ä¾‹: æ®‹é«˜ãŒ100ã‚ˆã‚Šå°‘ãªã„å ´åˆã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ›´æ–°
ACT IF (CONDITION: ALPHA_BALANCE < 100)
    ACT LET (K: STATUS_MESSAGE, V: "æ®‹é«˜ä¸è¶³ã®ãŸã‚ã€MINTã¯ä¿ç•™ã•ã‚Œã¾ã—ãŸ")
    END ACT
END ACT

// çµŒæ¸ˆãƒ­ã‚¸ãƒƒã‚¯ä¾‹: æ®‹é«˜ãŒ50ä»¥ä¸Šã®å ´åˆã€åˆ¥ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ›´æ–°
ACT IF (CONDITION: ALPHA_BALANCE >= 50)
    ACT LET (K: STATUS_MESSAGE, V: "æ®‹é«˜ç¢ºèªå®Œäº†ã€‚å–å¼•å¯èƒ½ã§ã™")
    END ACT
END ACT


// --- ğŸ–¼ï¸ ACT DEPLOY: è¨ˆç®—çµæœã‚’æç”» ---
ACT DEPLOY
    ['div', {'style': 'padding: 15px; background-color: #2c0b43; border-radius: 5px; border: 1px solid #ff5757;'}, [
        ['h3', {'style': 'color: #fff;'}, ['CalcHost: æ„æ€æ±ºå®šçµæœ']],
        ['p', {}, ['ç¾åœ¨ã®ALPHAæ®‹é«˜: ', ALPHA_BALANCE]],
        ['p', {}, ['æœ€çµ‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: ', STATUS_MESSAGE]],
        ['p', {'style': 'font-size: 10px;'}, ['æœ€çµ‚ã‚µã‚¤ã‚¯ãƒ«:', REGISTRY_CYCLE]]
    ]]
END ACT
        </textarea>
        
        <button class="btn btn-run" onclick="CalcOS.executeLogic()">
            â–¶ï¸ ä½œç‚ºã‚’ VM ã§å®Ÿè¡Œ (Execute)
        </button>
        <button class="btn btn-run" onclick="CalcOS.renderHost()">
            ğŸ–¼ï¸ CalcHostã¸æç”» (ACT RENDER)
        </button>
        
        <h3 style="color: #ff5757; margin-top: 20px;">ğŸ“œ Calc-Audit Log (ç›£æŸ»è¨˜éŒ²)</h3>
        <div id="audit-log-output">
        </div>
    </div>
    
    <div id="calchost-output">
        <h2>ğŸŒ CalcHost - è«–ç†çš„æç”»é ˜åŸŸ</h2>
        <div id="calchost-content">
            CalcHostã®åˆæœŸæ²ˆé»™çŠ¶æ…‹... (ACT RENDERã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„)
        </div>
    </div>

    <script>
        // UIè¦ç´ ã®å‚ç…§
        const $code = document.getElementById('calc-code');
        const $cycleValue = document.getElementById('cycle-value');
        const $varsValue = document.getElementById('vars-value');
        const $calcHostContent = document.getElementById('calchost-content');
        const $auditLogOutput = document.getElementById('audit-log-output');

        // ğŸ§  --- Calc-OS (è«–ç†çš„ã‚ªãƒšãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ ) ã‚³ã‚¢å®šç¾© ---
        const CalcOS = (function() {
            let REGISTRY;

            // Calc-OSã®åˆæœŸè«–ç†å®šç¾© (v8.0ãƒ¬ã‚¸ã‚¹ãƒˆãƒª)
            const DEFAULT_REGISTRY = {
                REGISTRY_CYCLE: 0, 
                REGISTRY_VARS: {}, 
                REGISTRY_HOST_S_EXPR: null, 
                REGISTRY_AUDIT_LOG: [],
            };

            // [v8.0æ–°è¦] æ¯”è¼ƒæ¼”ç®—å­ã¨ãã®é–¢æ•°ãƒãƒƒãƒ—
            const COMPARISON_OPS = {
                '>': (a, b) => a > b,
                '<': (a, b) => a < b,
                '>=': (a, b) => a >= b,
                '<=': (a, b) => a <= b,
                '==': (a, b) => a === b,
                '!=': (a, b) => a !== b,
            };

            // å¤–éƒ¨API: UIæ›´æ–°
            function updateUI() {
                $cycleValue.textContent = REGISTRY.REGISTRY_CYCLE;
                $varsValue.textContent = JSON.stringify(REGISTRY.REGISTRY_VARS);
                updateAuditLogUI();
            }
            
            // å¤–éƒ¨API: ç›£æŸ»ãƒ­ã‚°UIæ›´æ–°
            function updateAuditLogUI() {
                $auditLogOutput.innerHTML = REGISTRY.REGISTRY_AUDIT_LOG.map(log => {
                    const color = log.type === 'SUCCESS' ? 'yellowgreen' : 'red';
                    return `<div class="log-entry" style="color: ${color};">
                        [C:${log.cycle}] [${log.type}] ${log.message}
                    </div>`;
                }).join('');
                $auditLogOutput.scrollTop = $auditLogOutput.scrollHeight;
            }

            // ACT LOGã®é¡åƒ
            function logAudit(type, message) {
                const entry = { type, message, cycle: REGISTRY.REGISTRY_CYCLE };
                REGISTRY.REGISTRY_AUDIT_LOG.push(entry);
                if (REGISTRY.REGISTRY_AUDIT_LOG.length > 30) {
                    REGISTRY.REGISTRY_AUDIT_LOG.shift();
                }
            }

            // Calc-OSã®ãƒ–ãƒ¼ãƒˆã‚¹ãƒˆãƒ©ãƒƒãƒ—ã¨åˆæœŸåŒ–
            function init() {
                REGISTRY = JSON.parse(JSON.stringify(DEFAULT_REGISTRY));
                updateUI();
                logAudit('INIT', 'æ•°ç†çš„æ²ˆé»™ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚° v8.0ãŒèµ·å‹•ã—ã¾ã—ãŸã€‚');
            }
            
            // Calc-ACT Parser (å…¬ç†ãƒ–ãƒ­ãƒƒã‚¯ã®æŠ½å‡º) - v8.0å¯¾å¿œ
            function parseCalcCode(code) {
                const actBlocks = [];
                // ACT [NAME] (optional parameters) ... END ACT
                const regex = /(ACT\s+\w+.*?END\s+ACT)/gs; 
                let match;
                while ((match = regex.exec(code)) !== null) {
                    actBlocks.push(match[1].trim());
                }
                return actBlocks;
            }
            
            // Calc-ACT Parser (å€‹ã€…ã®å…¬ç†ãƒ–ãƒ­ãƒƒã‚¯ã®è§£æ) - v8.0å¯¾å¿œ
            function parseAct(actBlock) {
                const headerMatch = actBlock.match(/^ACT\s+(\w+)\s*(?:\((.*?)\))?/s);
                let actName, paramsStr, body;

                if (headerMatch) {
                    actName = headerMatch[1]; 
                    paramsStr = headerMatch[2] || ''; 
                    body = actBlock.substring(headerMatch[0].length, actBlock.lastIndexOf('END ACT')).trim();
                } else {
                    const bodyMatch = actBlock.match(/^ACT\s+(\w+)(.*?END\s+ACT)/s);
                    if (bodyMatch) {
                        actName = bodyMatch[1];
                        paramsStr = '';
                        body = bodyMatch[2].trim().replace(/END\s+ACT$/, '').trim();
                    } else {
                        throw new Error("ACTãƒ˜ãƒƒãƒ€æ§‹æ–‡ã‚¨ãƒ©ãƒ¼");
                    }
                }
                
                const params = {};
                paramsStr.split(',').forEach(param => {
                    const parts = param.trim().split(':').map(p => p.trim());
                    if (parts.length === 2) {
                        // ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å€¤ã®ã‚¯ã‚©ãƒ¼ãƒˆã‚’é™¤å»
                        params[parts[0]] = parts[1].replace(/^"|"$/g, '').trim(); 
                    }
                });

                return {
                    name: actName,
                    params: params,
                    body: body,
                    fullCode: actBlock
                };
            }

            // å¤‰æ•°ã¾ãŸã¯ãƒªãƒ†ãƒ©ãƒ«å€¤ã‚’å–å¾—ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° (v8.0)
            function resolveValue(keyOrLiteral) {
                const value = REGISTRY.REGISTRY_VARS[keyOrLiteral];
                
                if (value !== undefined) {
                    return value;
                }
                
                const num = Number(keyOrLiteral);
                if (!isNaN(num)) {
                    return num;
                }
                
                return keyOrLiteral;
            }

            // Så¼å†…ã®ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰å¤‰æ•°ã‚’ç½®æ›ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° (v8.0)
            function substituteVars(text) {
                let substitutedText = text;
                substitutedText = substitutedText.replace(/REGISTRY_CYCLE/g, REGISTRY.REGISTRY_CYCLE);

                for (const key in REGISTRY.REGISTRY_VARS) {
                    const regex = new RegExp(key, 'g'); 
                    substitutedText = substitutedText.replace(regex, REGISTRY.REGISTRY_VARS[key]);
                }
                
                return substitutedText;
            }

            // [v8.0æ–°è¦] ACT IFã®æ¡ä»¶å¼ã‚’è©•ä¾¡ã™ã‚‹é–¢æ•°
            function evaluateCondition(conditionStr) {
                // æ¡ä»¶å¼ã‚’ V1 OP V2 ã®å½¢å¼ã§è§£æ (ä¾‹: ALPHA_BALANCE < 100)
                const parts = conditionStr.match(/(\w+|\d+)\s*([<|>|<=|>=|==|!=])\s*(\w+|\d+)/);
                
                if (!parts || parts.length !== 4) {
                    throw new Error(`IFæ¡ä»¶å¼æ§‹æ–‡ã‚¨ãƒ©ãƒ¼: ${conditionStr}`);
                }

                const v1Key = parts[1].trim();
                const op = parts[2].trim();
                const v2Key = parts[3].trim();
                
                // å¤‰æ•°/ãƒªãƒ†ãƒ©ãƒ«ã®å€¤ã‚’è§£æ±º
                const v1 = resolveValue(v1Key);
                const v2 = resolveValue(v2Key);

                const operatorFn = COMPARISON_OPS[op];
                if (!operatorFn) {
                    throw new Error(`IFæ¡ä»¶å¼: æœªçŸ¥ã®æ¯”è¼ƒæ¼”ç®—å­ ${op}`);
                }

                // æ•°å€¤å‹ã§ã®æ¯”è¼ƒã‚’è©¦ã¿ã‚‹
                if (typeof v1 === 'number' && typeof v2 === 'number') {
                    return operatorFn(v1, v2);
                } 
                
                // ãã‚Œä»¥å¤–ï¼ˆæ–‡å­—åˆ—ãªã©ï¼‰ã¯å³å¯†æ¯”è¼ƒ
                return operatorFn(v1.toString(), v2.toString());
            }

            // ACT RENDER å…¬ç†ã®æ ¸ (v8.0ãƒ­ã‚¸ãƒƒã‚¯ã‚’ä¿æŒ)
            function renderSExpr(sExpr) {
                if (typeof sExpr === 'string') {
                    return document.createTextNode(substituteVars(sExpr));
                }
                
                const [tagName, attributes, childrenArray] = sExpr;
                const children = Array.isArray(childrenArray) ? childrenArray : [];
                
                if (typeof tagName !== 'string' || typeof attributes !== 'object') {
                    throw new Error(`Invalid S-Expr header: ${tagName}, ${attributes}`);
                }

                const element = document.createElement(tagName);

                for (const key in attributes) {
                    if (attributes.hasOwnProperty(key)) {
                        element.setAttribute(key, substituteVars(attributes[key]));
                    }
                }

                for (const child of children) {
                    element.appendChild(renderSExpr(child));
                }

                return element;
            }


            // Calc-VM (ACTå…¬ç†å®Ÿè¡Œã‚¨ãƒ³ã‚¸ãƒ³) - å®Ÿè¡Œæœ¬ä½“
            function vmExecuteAct(act) {
                const actName = act.name;
                const actParams = act.params;

                // --- å…¬ç†: ACT LET ---
                if (actName === 'LET') {
                    const key = actParams.K;
                    let value = actParams.V;
                    const resolvedValue = resolveValue(value);
                    if (typeof resolvedValue !== 'string' || !isNaN(Number(resolvedValue))) {
                         value = resolvedValue;
                    }
                    if (key && value !== undefined) {
                        REGISTRY.REGISTRY_VARS[key] = value;
                        REGISTRY.REGISTRY_CYCLE += 1;
                        logAudit('SUCCESS', `ACT LETãŒå®Œäº†: ${key} = ${value}`);
                    } else {
                        throw new Error("K/Vãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚");
                    }
                    return "SUCCESS";
                }
                
                // --- å…¬ç†: ACT CALC ---
                if (actName === 'CALC') {
                    const K = actParams.K;
                    const OP = actParams.OP;
                    const V1 = resolveValue(actParams.V1);
                    const V2 = resolveValue(actParams.V2);
                    if (typeof V1 !== 'number' || typeof V2 !== 'number') {
                         throw new Error(`CALCå¤±æ•—: V1 (${actParams.V1}) ã¾ãŸã¯ V2 (${actParams.V2}) ãŒæ•°å€¤ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚`);
                    }
                    let result;
                    switch (OP) {
                        case 'ADD': result = V1 + V2; break;
                        case 'SUB': result = V1 - V2; break;
                        case 'MUL': result = V1 * V2; break;
                        case 'DIV': 
                            if (V2 === 0) throw new Error("CALCå¤±æ•—: ã‚¼ãƒ­é™¤ç®—ã‚¨ãƒ©ãƒ¼");
                            result = V1 / V2; 
                            break;
                        default:
                            throw new Error(`CALCå¤±æ•—: æœªçŸ¥ã®æ¼”ç®—å­ ${OP}`);
                    }
                    REGISTRY.REGISTRY_VARS[K] = result;
                    REGISTRY.REGISTRY_CYCLE += 1;
                    logAudit('SUCCESS', `ACT CALCãŒå®Œäº†: ${K} = ${V1} ${OP} ${V2} = ${result}`);
                    return "SUCCESS";
                }

                // --- [v8.0æ–°è¦] å…¬ç†: ACT IF (æ¡ä»¶åˆ†å²) ---
                if (actName === 'IF') {
                    const conditionStr = actParams.CONDITION;
                    let result;
                    try {
                        result = evaluateCondition(conditionStr);
                    } catch (e) {
                         logAudit('ERROR', `ACT IFæ¡ä»¶è©•ä¾¡å¤±æ•—: ${e.message}`);
                         throw new Error("IFæ¡ä»¶è©•ä¾¡å¤±æ•—");
                    }
                    
                    logAudit('AUDIT', `ACT IF: æ¡ä»¶ "${conditionStr}" ã®è©•ä¾¡çµæœã¯ ${result} ã§ã™ã€‚`);

                    if (result === true) {
                        const nestedActList = parseCalcCode(act.body);
                        for (const nestedActCode of nestedActList) {
                            const nestedAct = parseAct(nestedActCode);
                            vmExecuteAct(nestedAct);
                        }
                        logAudit('SUCCESS', 'ACT IF: æ¡ä»¶ãŒçœŸã®ãŸã‚ã€å†…éƒ¨ACTã‚’å®Ÿè¡Œã—ã¾ã—ãŸã€‚');
                    } else {
                        logAudit('AUDIT', 'ACT IF: æ¡ä»¶ãŒå½ã®ãŸã‚ã€å†…éƒ¨ACTã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸã€‚');
                    }
                    return "SUCCESS";
                }

                // --- å…¬ç†: ACT LOOP ---
                if (actName === 'LOOP') {
                    const count = parseInt(actParams.COUNT, 10);
                    if (isNaN(count) || count <= 0) {
                        throw new Error(`LOOPå¤±æ•—: ç„¡åŠ¹ãªã‚«ã‚¦ãƒ³ãƒˆå€¤ ${actParams.COUNT}ã€‚`);
                    }
                    const nestedActList = parseCalcCode(act.body); 
                    for (let i = 0; i < count; i++) {
                        for (const nestedActCode of nestedActList) {
                            const nestedAct = parseAct(nestedActCode);
                            vmExecuteAct(nestedAct);
                        }
                    }
                    logAudit('SUCCESS', `ACT LOOPãŒå®Œäº†ã—ã¾ã—ãŸ (${count}å›)ã€‚`);
                    return "SUCCESS";
                }
                
                // --- å…¬ç†: ACT DEPLOY ---
                if (actName === 'DEPLOY') {
                    try {
                        const parsedSExpr = JSON.parse(act.body); 
                        REGISTRY.REGISTRY_HOST_S_EXPR = parsedSExpr; 
                        REGISTRY.REGISTRY_CYCLE += 1;
                        logAudit('SUCCESS', 'ACT DEPLOYãŒå®Œäº†ã€‚Så¼ãŒREGISTRYã«æ ¼ç´ã•ã‚Œã¾ã—ãŸã€‚');
                    } catch (e) {
                        logAudit('ERROR', `DEPLOYå¤±æ•—: Så¼ãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼: ${e.message}`);
                        throw new Error("DEPLOYå¤±æ•—");
                    }
                    return "SUCCESS";
                }
                
                throw new Error(`VM: æœªçŸ¥ã®ACTå…¬ç† '${actName}' ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚`);
            }
            
            // Calc-VMã®å…¨ä½“å®Ÿè¡Œãƒ­ã‚¸ãƒƒã‚¯
            function executeAct(actCode) {
                // v8.0ã§è¿½åŠ ã•ã‚ŒãŸACT IO, ACT STRINGã¯ã€ã“ã®ã‚³ã‚¢ã«ã¯å«ã¾ã‚Œã¦ã„ã¾ã›ã‚“ãŒã€
                // å®Ÿè¡Œãƒ­ã‚¸ãƒƒã‚¯è‡ªä½“ã¯æ±ç”¨çš„ã«å‹•ä½œã—ã¾ã™ã€‚
                let actList;
                try {
                    actList = parseCalcCode(actCode);
                } catch(e) {
                    logAudit('ERROR', `ã‚³ãƒ¼ãƒ‰è§£æã‚¨ãƒ©ãƒ¼: ${e.message}`);
                    return { status: "ERROR", reason: "PARSER_FAILURE" };
                }

                let overallStatus = "SUCCESS";
                
                for (const actBlock of actList) {
                    try {
                        const act = parseAct(actBlock);
                        vmExecuteAct(act); 
                    } catch (e) {
                        logAudit('ERROR', `ACTå®Ÿè¡Œå¤±æ•—: ${e.message} [ã‚³ãƒ¼ãƒ‰: ${actBlock.substring(0, 50)}...]`);
                        overallStatus = "ERROR";
                    }
                }
                
                return { status: overallStatus, reason: overallStatus === "SUCCESS" ? "ALL_ACTS_EXECUTED" : "EXECUTION_ERROR" };
            }


            return {
                init: init,
                executeLogic: function() {
                    const result = executeAct($code.value); 
                    updateUI();
                    return result;
                },
                renderHost: function() {
                    $calcHostContent.innerHTML = ''; 
                    
                    const sExpr = REGISTRY.REGISTRY_HOST_S_EXPR;

                    if (!sExpr) {
                        $calcHostContent.innerHTML = 'CalcHost: DEPLOYãŒå®Ÿè¡Œã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚';
                        return;
                    }

                    try {
                        const renderedElement = renderSExpr(sExpr);
                        $calcHostContent.appendChild(renderedElement); 
                        logAudit('RENDER', 'CalcHostã¸ã®Så¼æç”» (ACT RENDER) ã‚’å®Ÿè¡Œã—ã¾ã—ãŸã€‚');
                    } catch (e) {
                        logAudit('ERROR', `ACT RENDERå¤±æ•—: æç”»ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ: ${e.message}`);
                        $calcHostContent.innerHTML = `<p style="color: red; padding: 10px;">RENDER ERROR: ${e.message}</p>`;
                    }
                    updateUI();
                },
            };
        })();

        // èµ·å‹•
        window.onload = CalcOS.init;
    </script>
</body>
</html>
