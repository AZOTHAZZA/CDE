<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CalcLang è¨˜è¿°ç’°å¢ƒ (CDE) - æ•°ç†çš„æ²ˆé»™ã®ãƒ¡ãƒ¢å¸³ v5.1 (ACT CONVERSE)</title>
    <style>
        body {
            background-color: #1a1a2e;
            color: #ffffff;
            font-family: 'Consolas', 'Courier New', monospace;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 40px;
        }
        #cde-container {
            width: 800px;
            max-width: 90vw;
            background-color: #2c0b43;
            border: 5px solid #6c4692;
            box-shadow: 0 0 30px rgba(108, 70, 146, 0.5);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        textarea {
            width: 100%;
            height: 300px;
            background-color: #0d061c;
            color: #d4d4d4;
            border: 1px solid #4a2f60;
            padding: 15px;
            resize: none;
            font-size: 14px;
            outline: none;
            margin-bottom: 15px;
        }
        .status-box {
            margin-top: 20px;
            padding: 10px;
            border-radius: 5px;
            font-weight: bold;
        }
        .status-success { background-color: #216140; }
        .status-halted { background-color: #7d2a2a; }
        .btn {
            padding: 8px 15px;
            background-color: #6c4692;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-right: 10px;
        }
        .btn:hover {
            background-color: #8c5fb2;
        }
        .btn-file { background-color: #4a2f60; }
        .btn-file:hover { background-color: #60467a; }
        .btn-run { background-color: #2c0b43; }
        .btn-run:hover { background-color: #401a60; }

        /* CalcHost å‡ºåŠ›ã‚¨ãƒªã‚¢ */
        #calchost-output {
            margin-top: 30px;
            padding: 20px;
            border: 3px solid #f9d342;
            background-color: #0d061c;
            color: #f9d342;
            min-height: 100px;
            border-radius: 10px;
            width: 800px;
            max-width: 90vw;
            box-sizing: border-box;
            font-size: 14px;
        }
        #calchost-output h2 { color: #ffffff; border-bottom: 1px solid #f9d342; padding-bottom: 5px;}
        
        /* ç›£æŸ»ãƒ­ã‚°ã‚¨ãƒªã‚¢ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #audit-log-output {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #4a2f60;
            background-color: #0d061c;
            max-height: 100px;
            overflow-y: scroll;
            font-size: 12px;
            color: #bbb;
        }
        .log-entry {
            border-bottom: 1px dotted #333;
            padding: 3px 0;
        }
        
        /* æ–°ã—ã„REGISTRY_CONTEXTã¨OUTPUTè¡¨ç¤º */
        #context-output {
            margin-top: 10px;
            padding: 10px;
            border: 1px solid #ff99ff; 
            background-color: #1c0a2e;
            color: #ff99ff;
            font-size: 12px;
            max-height: 80px;
            overflow-y: auto;
        }
        #output-display {
            margin-top: 10px;
            padding: 15px;
            border: 2px solid #50fa7b; /* ç·‘ */
            background-color: #1a2a2e;
            color: #50fa7b;
            font-size: 14px;
            font-weight: bold;
        }

    </style>
</head>
<body>
    <div id="cde-container">
        <h1 style="color: #a47fe0;">CalcLang è¨˜è¿°ç’°å¢ƒ (CDE) Î©Î¶ (ACT CONVERSE) v5.1</h1>
        <p style="color: #ccc; font-size: small;">
            å¯¾è©±å‹ AI æ§‹ç¯‰ã®æœ€çµ‚æ®µéšã€‚å…¥å‡ºåŠ›ã¨å¯¾è©±ã®å…¬ç†ã‚’å°å…¥ã€‚
        </p>

        <div class="status-box" id="halt-status">
            âœ… **ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹:** æ­£å¸¸ç¨¼åƒ
        </div>
        <p>
            <strong>ç¾åœ¨ã® ALPHA:</strong> USER_A: <span id="alpha-balance-a">1000.00</span> | USER_B: <span id="alpha-balance-b">1000.00</span><br>
            <strong>ç¾åœ¨ã® BETA:</strong> USER_A: <span id="beta-balance-a">100.00</span> | USER_B: <span id="beta-balance-b">100.00</span><br>
            <strong>REGISTRY_VIBE (è«–ç†æŒ¯å‹•):</strong> <span id="vibe-value">100.00</span> | <strong>REGISTRY_CYCLE (è«–ç†ã‚µã‚¤ã‚¯ãƒ«):</strong> <span id="cycle-value">0</span>
        </p>
        
        <h3 style="color: #ff99ff;">ğŸ§  REGISTRY_CONTEXT (AIã®è¨˜æ†¶)</h3>
        <div id="context-output">
            </div>
        
        <h3 style="color: #50fa7b;">ğŸ¤– REGISTRY_OUTPUT (AIã®å¿œç­”)</h3>
        <div id="output-display">
            AIã¯å¿œç­”ã‚’å¾…ã£ã¦ã„ã¾ã™...
        </div>

        <div style="margin-bottom: 15px; margin-top: 15px;">
            <button class="btn btn-file" onclick="CalcOS.saveLogic()">ğŸ’¾ è«–ç†ã®ã‚³ãƒŸãƒƒãƒˆ (ä¿å­˜)</button>
            <button class="btn btn-file" onclick="CalcOS.loadLogic()">ğŸ“‚ è«–ç†ã®å¾©å…ƒ (é–‹ã)</button>
            <button class="btn btn-file" onclick="CalcOS.newLogic()">ğŸ“„ æ–°è¦ä½œæˆ (æ²ˆé»™ã®å†ç¢ºç«‹)</button>
        </div>
        
        <button class="btn btn-run" onclick="CalcOS.renderHost()">
            ğŸ–¼ï¸ CalcHostã¸æç”» (ACT RENDER)
        </button>

        <label for="calc-code" style="display: block; margin-top: 15px;">
            CalcLang è«–ç†è¨˜è¿° (ACTå…¬ç†):
        </label>
        <textarea id="calc-code">
// --- ğŸ›‘ è«–ç†ã®åœæ­¢æ¡ä»¶ï¼ˆæ¨©åŠ›æ’é™¤ã®å…¬ç†ï¼‰ ---
ACT HALT LOGIC (CHECK: REGISTRY_ALPHA[USER_A] > 1005.00, REASON: "çµŒæ¸ˆæ´»å‹•ã®æœ‰é™ãªè«–ç†çš„æ¥µé™ã¸ã®åˆ°é”ã€‚æ¨©åŠ›ã®é™æ­¢ã‚’å…¬ç†åŒ–ã€‚")
END ACT

// --- ğŸ“ˆ çµŒæ¸ˆã®æ±ºå®šè«–çš„ä½œç‚ºï¼ˆACT DIVERGENCEï¼‰ ---
ACT DIVERGENCE (CHECK: REGISTRY_ALPHA[USER_A] < 1002.00, D_ACT: MINT (T: USER_A, A: 1.0), S_ACT: ACT SWAP (USER: USER_A, FROM: ALPHA, TO: BETA, AMOUNT: 0.1, RATE: 2.0), C_ACT: ACT REFLECT (TARGET: VIBE, SOURCE: CYCLE, FACTOR: 0.001))
END ACT

// --- ğŸ—£ï¸ ACT CONVERSE (å¯¾è©±å…¬ç† - AIä¸­æ ¸) ---
ACT CONVERSE (INPUT: USER_PROMPT, OUTPUT: AI_RESPONSE)
    IF REGISTRY_HALT == TRUE THEN CALC_HALT
    
    // 1. ACT PARSEã®è‡ªå‹•å®Ÿè¡Œ (ç¾åœ¨ã®è«–ç†ã‚’ç†è§£)
    ACT PARSE (SOURCE: CODE, TARGET: CONTEXT)
    
    // 2. INPUTã®è§£æã¨CONTEXTã¸ã®è¿½åŠ  (å¯¾è©±ã®é–‹å§‹)
    SET REGISTRY_CONTEXT = APPEND(REGISTRY_CONTEXT, "USER: " + USER_PROMPT)
    SET REGISTRY_INPUT = USER_PROMPT // ç°¡æ˜“çš„ãªä¿å­˜

    // 3. å¿œç­”ç”Ÿæˆã®æ±ºå®šè«–çš„ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆLLMã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
    IF CONTAINS(USER_PROMPT, "MINT") THEN
        LET MINT_COUNT = COUNT_ACTS(REGISTRY_CODE, "MINT")
        SET REGISTRY_OUTPUT = "MINTå…¬ç†ã«ã¤ã„ã¦ã€ç¾åœ¨ " + MINT_COUNT + " ã®å®šç¾©ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚è¿½åŠ ã‚’ææ¡ˆã—ã¾ã™ã€‚"
        
        // å¿œç­”å¾Œã€æ¬¡ã®ACT GENERATEã®å®Ÿè¡Œã‚’ææ¡ˆã™ã‚‹
        ACT GENERATE (SOURCE: CONTEXT, TARGET: CODE, PROMPT: "æ–°ã—ã„MINTå…¬ç†ã‚’ææ¡ˆ")
    ELSE IF CONTAINS(USER_PROMPT, "VIBE") THEN
        SET REGISTRY_OUTPUT = "ç¾åœ¨ã®VIBEã¯ " + REGISTRY_VIBE + " ã§ã™ã€‚ACT REFLECTã«ã‚ˆã‚Šå¶å¥‡ã§ä¿®æ­£ã•ã‚Œã¦ã„ã¾ã™ã€‚"
    ELSE
        SET REGISTRY_OUTPUT = "ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¦æ±‚ã‚’CONTEXTã«è¿½åŠ ã—ã¾ã—ãŸã€‚å…·ä½“çš„ãªè«–ç†ä½œç‚ºã‚’æŒ‡ç¤ºã—ã¦ãã ã•ã„ã€‚"
    END IF

    LOG("CONVERSE: å¯¾è©±ã‚µã‚¤ã‚¯ãƒ«ã‚’å®Œäº†ã€‚AIãŒå¿œç­”ã‚’ç”Ÿæˆã—ã¾ã—ãŸã€‚")
END ACT

// --- ğŸ§  ACT PARSE (è«–ç†ã®ç†è§£å…¬ç†) ---
ACT PARSE (SOURCE: CODE, TARGET: CONTEXT)
    IF REGISTRY_HALT == TRUE THEN CALC_HALT
    SET REGISTRY_CODE = CODE_TEXT 
    
    LET MINT_COUNT = COUNT_ACTS(REGISTRY_CODE, "MINT")
    LET HALT_CHECK = GET_PARAM(REGISTRY_CODE, "HALT LOGIC", "CHECK")

    SET REGISTRY_CONTEXT = APPEND(REGISTRY_CONTEXT, "ç›£æŸ»ï¼šMINTå…¬ç†ã¯" + MINT_COUNT + "å›å®šç¾©ã•ã‚Œã¦ã„ã¾ã™ã€‚")
    
    IF MINT_COUNT == 0 THEN CALC_HALT 
END ACT

// --- âœï¸ ACT GENERATE (è«–ç†ã®ç”Ÿæˆå…¬ç†) ---
ACT GENERATE (SOURCE: CONTEXT, TARGET: CODE, PROMPT: "æ–°ã—ã„MINTå…¬ç†ã‚’ææ¡ˆ")
    IF REGISTRY_HALT == TRUE THEN CALC_HALT
    
    // CONTEXTï¼ˆç¾åœ¨ã®ç›£æŸ»çµæœï¼‰ã«åŸºã¥ãã€æ–°ã—ã„ã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã™ã‚‹ãƒ•ãƒƒã‚¯
    LET NEW_ACT = "\n// --- ğŸ¤– AIææ¡ˆ MINT V2 --- \nACT MINT_V2 (T: USER_A, A: 20.0)\n    IF REGISTRY_VIBE > 102.00 THEN CALC_HALT \n    SET REGISTRY_ALPHA[T] = ADD(REGISTRY_ALPHA[T], A)\n    SET REGISTRY_VIBE = ADD_VIBE(REGISTRY_VIBE)\nEND ACT\n"

    SET REGISTRY_CODE = ADD_TO_CODE(REGISTRY_CODE, NEW_ACT)
    
    LOG("GENERATE: AIãŒæ–°ã—ã„å…¬ç†ï¼ˆMINT_V2ï¼‰ã‚’ã‚³ãƒ¼ãƒ‰ã«è¿½åŠ ã—ã¾ã—ãŸã€‚") 
END ACT

// --- ğŸ”® è£œåŠ©å…¬ç†: ACT REFLECT (è‡ªå·±ä¿®æ­£å¾‹ã®å…¬ç†) ---
ACT REFLECT (TARGET: VIBE, SOURCE: CYCLE, FACTOR: 0.001)
    IF REGISTRY_HALT == TRUE THEN CALC_HALT
    IF MOD(REGISTRY_CYCLE, 2) == 0 THEN
        SET REGISTRY_VIBE = SUB(REGISTRY_VIBE, MUL(REGISTRY_VIBE, FACTOR))
    ELSE
        SET REGISTRY_VIBE = ADD(REGISTRY_VIBE, MUL(REGISTRY_VIBE, FACTOR))
    END IF
    SET REGISTRY_CYCLE = ADD(REGISTRY_CYCLE, 1) 
    IF REGISTRY_VIBE > 105.00 OR REGISTRY_VIBE < 95.00 THEN CALC_HALT
END ACT

// --- ğŸ” è£œåŠ©å…¬ç†: ACT SWAP (å¸‚å ´ã®äº¤æ›å¾‹ã®å…¬ç†) ---
ACT SWAP (USER: USER_A, FROM: ALPHA, TO: BETA, AMOUNT: 1.0, RATE: 1.0)
    IF REGISTRY_HALT == TRUE THEN CALC_HALT
    IF FROM == TO THEN CALC_HALT 
    
    LET REGISTRY_FROM = (FROM == ALPHA) ? REGISTRY_ALPHA : REGISTRY_BETA
    LET REGISTRY_TO = (TO == ALPHA) ? REGISTRY_ALPHA : REGISTRY_BETA
    
    LET FIXED_AMOUNT = AMOUNT
    SET REGISTRY_FROM[USER] = SUB(REGISTRY_FROM[USER], FIXED_AMOUNT)
    SET REGISTRY_TO[USER] = ADD(REGISTRY_TO[USER], MUL(FIXED_AMOUNT, RATE))

    SET REGISTRY_VIBE = ADD_VIBE_SMALL(REGISTRY_VIBE) 
    IF REGISTRY_VIBE > 110.00 THEN CALC_HALT
END ACT

// --- ğŸ’° è£œåŠ©å…¬ç†: ACT MINT / ACT TRANSFER ---
ACT MINT (T: USER_A, A: 10.0)
    IF REGISTRY_HALT == TRUE THEN CALC_HALT
    SET REGISTRY_ALPHA[T] = ADD(REGISTRY_ALPHA[T], A)
    SET REGISTRY_VIBE = ADD_VIBE(REGISTRY_VIBE) 
    IF REGISTRY_VIBE > 110.00 THEN CALC_HALT 
END ACT

ACT TRANSFER (S: USER_A, R: USER_B, A: 50.0)
    IF REGISTRY_ALPHA[S] < A THEN CALC_HALT
    SET REGISTRY_ALPHA[S] = SUB(REGISTRY_ALPHA[S], A)
    SET REGISTRY_ALPHA[R] = ADD(REGISTRY_ALPHA[R], A)
    SET REGISTRY_VIBE = SUB_VIBE(REGISTRY_VIBE) 
    IF REGISTRY_VIBE < 90.00 THEN CALC_HALT 
END ACT
        </textarea>

        <button class="btn btn-run" onclick="CalcOS.executeLogic()">
            â–¶ï¸ ä½œç‚ºã‚’ VM ã§å®Ÿè¡Œ (Audit & Execute)
        </button>
        
        <h3 style="color: #6c4692; margin-top: 20px;">ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä½œç‚º (ACT CONVERSE)</h3>
        <input type="text" id="user-prompt" placeholder="AIã«è«–ç†ã®è³ªå•ã‚„ä¿®æ­£æŒ‡ç¤ºã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ (ä¾‹: MINTã®å…¬ç†ã‚’æ•™ãˆã¦)" style="width: 780px; padding: 10px; margin-bottom: 10px; background-color: #0d061c; color: #fff; border: 1px solid #6c4692;">
        <button class="btn btn-run" onclick="CalcOS.executeConverse()" style="background-color: #6c4692;">
            ğŸ’¬ ACT CONVERSE å®Ÿè¡Œ
        </button>

        <h3 style="color: #a47fe0; margin-top: 20px;">ğŸ“œ Calc-Audit Log (è«–ç†çš„ç›£æŸ»è¨˜éŒ²)</h3>
        <div id="audit-log-output">
            </div>
    </div>
    
    <div id="calchost-output">
        <h2>ğŸŒ CalcHost - è«–ç†çš„æç”»é ˜åŸŸ (ACT RENDERçµæœ)</h2>
        <div id="calchost-content">
            CalcHostã®åˆæœŸæ²ˆé»™çŠ¶æ…‹... (ACT RENDERã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„)
        </div>
    </div>


    <script>
        const STORAGE_KEY = 'CalcLang_CDE_Logic';
        
        // --- ğŸ”¢ Calc-Type System ã®é¡åƒ ---
        const FIXED_SCALE = 10000; 
        const TO_FIXED = (value) => Math.round(parseFloat(value) * FIXED_SCALE);
        const FROM_FIXED = (value) => value / FIXED_SCALE; 
        const ADD_FIXED = (a, b) => a + b; 
        const SUB_FIXED = (a, b) => a - b; 
        const MUL_FIXED = (a, b) => Math.round((BigInt(a) * BigInt(b)) / BigInt(FIXED_SCALE));

        // VIBEå®šæ•°
        const VIBE_DELTA_ADD = TO_FIXED(0.05);
        const VIBE_DELTA_SUB = TO_FIXED(0.01);
        const VIBE_DELTA_SWAP = TO_FIXED(0.005); 
        const VIBE_CEILING = TO_FIXED(110.00);
        const VIBE_FLOOR = TO_FIXED(90.00);

        // UIè¦ç´ ã®å‚ç…§
        const $code = document.getElementById('calc-code');
        const $promptInput = document.getElementById('user-prompt');
        const $balanceA = document.getElementById('alpha-balance-a');
        const $balanceB = document.getElementById('alpha-balance-b');
        const $betaA = document.getElementById('beta-balance-a'); 
        const $betaB = document.getElementById('beta-balance-b'); 
        const $vibeValue = document.getElementById('vibe-value');
        const $cycleValue = document.getElementById('cycle-value');
        const $status = document.getElementById('halt-status');
        const $calcHostContent = document.getElementById('calchost-content');
        const $auditLogOutput = document.getElementById('audit-log-output');
        const $contextOutput = document.getElementById('context-output');
        const $outputDisplay = document.getElementById('output-display');


        // ğŸ§  --- Calc-OS (è«–ç†çš„ã‚ªãƒšãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ ) ã‚³ã‚¢å®šç¾© ---
        const CalcOS = (function() {
            let REGISTRY;

            // Calc-OSã®åˆæœŸè«–ç†å®šç¾© (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ¬ã‚¸ã‚¹ãƒˆãƒª)
            const DEFAULT_REGISTRY = {
                REGISTRY_ALPHA: { 
                    "USER_A": TO_FIXED(1000.00), 
                    "USER_B": TO_FIXED(1000.00) 
                },
                REGISTRY_BETA: { 
                    "USER_A": TO_FIXED(100.00),
                    "USER_B": TO_FIXED(100.00)
                },
                REGISTRY_DEBT: { 
                    "USER_A": TO_FIXED(0.00),
                    "USER_B": TO_FIXED(0.00)
                },
                REGISTRY_CYCLE: 0, 
                REGISTRY_HALT: false,
                REGISTRY_VIBE: TO_FIXED(100.00),
                REGISTRY_HOST: `<h3 style="color: #f9d342;">CalcHost: ãƒ‡ãƒ—ãƒ­ã‚¤å¾…æ©Ÿä¸­</h3><p>ç¾åœ¨ã®è«–ç†ã‚µã‚¤ã‚¯ãƒ«: 0</p>`,
                REGISTRY_AUDIT_LOG: [],
                REGISTRY_THEOREMS: {},
                
                // --- AI/ãƒ†ã‚­ã‚¹ãƒˆãƒ¬ã‚¸ã‚¹ãƒˆãƒª ---
                REGISTRY_CODE: "",
                REGISTRY_CONTEXT: [],
                REGISTRY_INPUT: "", // æ–°è¦
                REGISTRY_OUTPUT: "AIã¯å¿œç­”ã‚’å¾…ã£ã¦ã„ã¾ã™...", // æ–°è¦
            };

            // UIæ›´æ–°
            function updateUI() {
                $balanceA.textContent = FROM_FIXED(REGISTRY.REGISTRY_ALPHA['USER_A']).toFixed(2);
                $balanceB.textContent = FROM_FIXED(REGISTRY.REGISTRY_ALPHA['USER_B']).toFixed(2);
                $betaA.textContent = FROM_FIXED(REGISTRY.REGISTRY_BETA['USER_A']).toFixed(2); 
                $betaB.textContent = FROM_FIXED(REGISTRY.REGISTRY_BETA['USER_B']).toFixed(2); 
                $vibeValue.textContent = FROM_FIXED(REGISTRY.REGISTRY_VIBE).toFixed(4); 
                $cycleValue.textContent = REGISTRY.REGISTRY_CYCLE;
                
                $status.textContent = REGISTRY.REGISTRY_HALT 
                    ? `âŒ ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹: CALC_HALT (è«–ç†çš„é€£ç¶šæ€§ç ´ç¶», Cycle: ${REGISTRY.REGISTRY_CYCLE})`
                    : `âœ… ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹: æ­£å¸¸ç¨¼åƒ (Cycle: ${REGISTRY.REGISTRY_CYCLE})`;
                
                $status.className = 'status-box ' + (REGISTRY.REGISTRY_HALT 
                    ? 'status-halted' : 'status-success');
                    
                updateAuditLogUI();
                updateContextUI(); 
                $outputDisplay.textContent = REGISTRY.REGISTRY_OUTPUT; // OUTPUTã®æ›´æ–°
            }

            // ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆUIæ›´æ–°
            function updateContextUI() {
                $contextOutput.innerHTML = REGISTRY.REGISTRY_CONTEXT.map(item => `<div>- ${item}</div>`).join('');
                $contextOutput.scrollTop = $contextOutput.scrollHeight;
            }

            // ACT LOGã®é¡åƒ
            function logAudit(type, message) {
                const entry = { type, message, cycle: REGISTRY.REGISTRY_CYCLE };
                REGISTRY.REGISTRY_AUDIT_LOG.push(entry);
                if (REGISTRY.REGISTRY_AUDIT_LOG.length > 50) {
                    REGISTRY.REGISTRY_AUDIT_LOG.shift();
                }
            }

            // Calc-OSã®ãƒ–ãƒ¼ãƒˆã‚¹ãƒˆãƒ©ãƒƒãƒ—ã¨åˆæœŸåŒ–
            function init() {
                REGISTRY = JSON.parse(JSON.stringify(DEFAULT_REGISTRY));
                updateUI();
            }
            
            // ACT å…¬ç†ãƒ–ãƒ­ãƒƒã‚¯ã®æŠ½å‡º
            function parseCalcCode(code) {
                const actBlocks = [];
                // DEPLOYã‚„DIVERGENCEãªã©ã®å‡¦ç†...
                const deployRegex = /(ACT\s+DEPLOY\s+\(.*?\)[\s\S]*?END\s+ACT)/gi;
                let deployMatch;
                while ((deployMatch = deployRegex.exec(code)) !== null) { actBlocks.push(deployMatch[1].trim()); }
                const actRegex = /(ACT\s+(?!DEPLOY)\w+\s*\(.*?\).*?END\s+ACT)/gs; 
                let match;
                while ((match = actRegex.exec(code)) !== null) { actBlocks.push(match[1].trim()); }
                actBlocks.sort((a, b) => {
                    if (a.includes('ACT DIVERGENCE')) return -1;
                    if (b.includes('ACT DIVERGENCE')) return 1;
                    return 0;
                });
                return actBlocks;
            }
            
            // Calc-ACT Parser (å€‹ã€…ã®å…¬ç†ãƒ–ãƒ­ãƒƒã‚¯ã®è§£æ)
            function parseAct(actBlock) {
                const headerMatch = actBlock.match(/^ACT\s+(\w+)\s*\((.*?)\)/s);
                if (!headerMatch) {
                    // ç°¡æ˜“ACTã®å‡¦ç†ï¼ˆå†…éƒ¨ACT MINTãªã©ï¼‰ã‚’ã“ã“ã§ã‚«ãƒãƒ¼
                    const simpleActMatch = actBlock.match(/^(ACT\s+\w+\s*\(.*?\))/);
                    if (simpleActMatch) {
                        const simpleHeader = simpleActMatch[1];
                        const nameMatch = simpleHeader.match(/ACT\s+(\w+)\s*\(/);
                        const name = nameMatch ? nameMatch[1] : '';
                        
                        const paramsStr = simpleHeader.match(/\(([^)]*)\)/)[1];
                        const params = {};
                        paramsStr.split(',').forEach(param => {
                            const parts = param.trim().split(':').map(p => p.trim());
                            if (parts.length === 2) { params[parts[0]] = parts[1]; }
                        });
                        return { name: name, params: params, body: "", fullCode: actBlock };
                    }
                    throw new Error("ACTãƒ˜ãƒƒãƒ€æ§‹æ–‡ã‚¨ãƒ©ãƒ¼");
                }
                
                const actName = headerMatch[1]; 
                let paramsStr = headerMatch[2]; 
                const body = actBlock.substring(headerMatch[0].length, actBlock.lastIndexOf('END ACT')).trim();
                
                const params = {};
                
                const ACT_PATTERNS = {
                    'HALT LOGIC': /CHECK:\s*(.*?),\s*REASON:\s*(.*)/s,
                    'DIVERGENCE': /CHECK:\s*(.*?),\s*D_ACT:\s*(.*?),\s*S_ACT:\s*(.*?),\s*C_ACT:\s*(.*)/s,
                    'REFLECT': /TARGET:\s*(.*?),\s*SOURCE:\s*(.*?),\s*FACTOR:\s*(.*)/s,
                    'PARSE': /SOURCE:\s*(.*?),\s*TARGET:\s*(.*)/s, 
                    'GENERAT': /SOURCE:\s*(.*?),\s*TARGET:\s*(.*?),\s*PROMPT:\s*(.*)/s,
                    'CONVERSE': /INPUT:\s*(.*?),\s*OUTPUT:\s*(.*)/s, // æ–°è¦: CONVERSE
                    'QUERY': /TARGET:\s*(.*?),\s*QUESTION:\s*(.*)/s, // æ–°è¦: QUERY
                };

                const pattern = ACT_PATTERNS[actName];
                if (pattern) {
                    const matches = paramsStr.match(pattern);
                    if (!matches) { throw new Error(`ACT ${actName} ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æ§‹æ–‡ã‚¨ãƒ©ãƒ¼`); }
                    
                    if (actName === 'HALT LOGIC') { params.CHECK = matches[1].trim(); params.REASON = matches[2].trim().replace(/"/g, ''); }
                    else if (actName === 'DIVERGENCE') { params.CHECK = matches[1].trim(); params.D_ACT = matches[2].trim(); params.S_ACT = matches[3].trim(); params.C_ACT = matches[4].trim(); }
                    else if (actName === 'REFLECT') { params.TARGET = matches[1].trim(); params.SOURCE = matches[2].trim(); params.FACTOR = matches[3].trim(); }
                    else if (actName === 'PARSE') { params.SOURCE = matches[1].trim(); params.TARGET = matches[2].trim(); }
                    else if (actName === 'CONVERSE') { params.INPUT = matches[1].trim(); params.OUTPUT = matches[2].trim(); } // CONVERSE
                    else if (actName === 'GENERAT') { params.SOURCE = matches[1].trim(); params.TARGET = matches[2].trim(); params.PROMPT = matches[3].trim().replace(/"/g, ''); }
                    else if (actName === 'QUERY') { params.TARGET = matches[1].trim(); params.QUESTION = matches[2].trim().replace(/"/g, ''); } // QUERY
                } else {
                    // MINT, TRANSFER, SWAPãªã©ã®è£œåŠ©å…¬ç†ã®ç°¡æ˜“è§£æ
                    paramsStr.split(',').forEach(param => {
                        const parts = param.trim().split(':').map(p => p.trim());
                        if (parts.length === 2) {
                            params[parts[0]] = parts[1].replace(/;$/, ''); 
                        }
                    });
                }
                return { name: actName, params: params, body: body, fullCode: actBlock };
            }
            
            // Calc-Condition Evaluator (å¤‰æ›´ãªã—)
            function evaluateCondition(condition) {
                 // ... (çœç•¥: å‰ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¨å¤‰æ›´ãªã—)
                const comparisonMatch = condition.match(/(\w+\[\w+\]|\w+)\s*(>|<|==)\s*([\d\.]+)/);
                if (!comparisonMatch) {
                    const modMatch = condition.match(/MOD\((\w+),\s*(\d+)\)\s*(>|<|==)\s*(\d+)/);
                    if (modMatch) {
                         const registryName = modMatch[1];
                         const modulus = parseInt(modMatch[2]);
                         const operator = modMatch[3];
                         const rightValue = parseInt(modMatch[4]);
                         const leftOperand = REGISTRY[registryName];
                         if (leftOperand === undefined) {
                             logAudit('HALT', `è«–ç†æ¡ä»¶: MOD()ã§æœªçŸ¥ã®ãƒ¬ã‚¸ã‚¹ãƒˆãƒªå€¤ ${registryName}`);
                             REGISTRY.REGISTRY_HALT = true;
                             return false;
                         }
                         const modResult = leftOperand % modulus;
                         switch (operator) {
                            case '>': return modResult > rightValue;
                            case '<': return modResult < rightValue;
                            case '==': return modResult === rightValue;
                            default: return false; 
                         }
                    }
                    logAudit('HALT', `è«–ç†æ¡ä»¶æ§‹æ–‡ã‚¨ãƒ©ãƒ¼: ${condition}`);
                    REGISTRY.REGISTRY_HALT = true;
                    return false;
                }
                
                const leftOperandStr = comparisonMatch[1];
                const operator = comparisonMatch[2];
                const rightOperandFloat = parseFloat(comparisonMatch[3]);
                let leftOperandValue;
                const registryMatch = leftOperandStr.match(/(\w+)\[(\w+)\]/);
                if (registryMatch) {
                    const regName = registryMatch[1];
                    const key = registryMatch[2];
                    leftOperandValue = REGISTRY[regName] && REGISTRY[regName][key];
                } else {
                    leftOperandValue = REGISTRY[leftOperandStr];
                }
                
                if (leftOperandValue === undefined) {
                    logAudit('HALT', `è«–ç†æ¡ä»¶: æœªçŸ¥ã®ãƒ¬ã‚¸ã‚¹ãƒˆãƒªå€¤ ${leftOperandStr}`);
                    REGISTRY.REGISTRY_HALT = true;
                    return false;
                }
                const fixedRightOperand = TO_FIXED(rightOperandFloat);

                switch (operator) {
                    case '>': return leftOperandValue > fixedRightOperand;
                    case '<': return leftOperandValue < fixedRightOperand;
                    case '==': return leftOperandValue === fixedRightOperand;
                    default: return false; 
                }
            }
            
            // ğŸ›‘ ACT HALT LOGICã®ç›£æŸ»ï¼ˆæœ€å„ªå…ˆç›£æŸ»ï¼‰
            function haltLogicAudit(actList) {
                // ... (çœç•¥: å‰ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¨å¤‰æ›´ãªã—)
                const haltLogicAct = actList.find(act => act.includes('ACT HALT LOGIC'));
                if (!haltLogicAct) return false;

                try {
                    const act = parseAct(haltLogicAct);
                    const checkCondition = act.params.CHECK;
                    const reason = act.params.REASON;

                    if (evaluateCondition(checkCondition)) {
                        REGISTRY.REGISTRY_HALT = true;
                        logAudit('HALT', `HALT LOGIC: å‰æ ${checkCondition} ãŒçœŸã®ãŸã‚ã€è«–ç†çš„æ¥µé™ã«åˆ°é”ã€‚ç†ç”±: ${reason}`);
                        return true;
                    }
                } catch (e) {
                    REGISTRY.REGISTRY_HALT = true;
                    logAudit('HALT', `HALT LOGIC å‡¦ç†ä¸­ã«è‡´å‘½çš„ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ: ${e.message}`);
                    return true;
                }
                return false;
            }

            // ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°: ãƒˆãƒ¼ã‚¯ãƒ³ãƒ¬ã‚¸ã‚¹ãƒˆãƒªã®è§£æ±º
            function resolveRegistry(tokenName) {
                if (tokenName === 'ALPHA') return REGISTRY.REGISTRY_ALPHA;
                if (tokenName === 'BETA') return REGISTRY.REGISTRY_BETA;
                return null;
            }

            // Calc-VM (ACTå…¬ç†å®Ÿè¡Œã‚¨ãƒ³ã‚¸ãƒ³)
            function executeAct(actCode) {
                if (REGISTRY.REGISTRY_HALT) {
                    logAudit('HALT', 'ã‚·ã‚¹ãƒ†ãƒ åœæ­¢çŠ¶æ…‹ã®ãŸã‚ã€å…¬ç†ã®å®Ÿè¡Œã‚’æ‹’å¦ã—ã¾ã—ãŸã€‚');
                    return { status: "HALTED", reason: "SYSTEM_HALTED_PRE_CHECK" };
                }
                
                let actList;
                try {
                    // actCodeãŒå˜ä¸€ã®ACTã®å ´åˆ
                    actList = parseCalcCode(actCode);
                } catch(e) {
                    logAudit('HALT', `ã‚³ãƒ¼ãƒ‰è§£æã‚¨ãƒ©ãƒ¼: ${e.message}`);
                    REGISTRY.REGISTRY_HALT = true;
                    return { status: "HALTED", reason: "PARSER_FAILURE" };
                }

                if (actList.length === 0) {
                    return { status: "SUCCESS", reason: "NO_ACT_EXECUTED" };
                }
                
                if (haltLogicAudit(actList)) {
                    return { status: "HALTED", reason: "HALT_LOGIC_ACTIVATED" };
                }
                
                let act;
                try {
                    act = parseAct(actList[0]);
                } catch(e) {
                     logAudit('HALT', `å…¬ç†è§£æã‚¨ãƒ©ãƒ¼: ${e.message}`);
                     REGISTRY.REGISTRY_HALT = true;
                     return { status: "HALTED", reason: "ACT_PARSING_FAILURE" };
                }
                
                const actName = act.name;
                const actParams = act.params;

                // --- ğŸ—£ï¸ ACT CONVERSE ã®å®Ÿè¡Œ (æ–°è¦) ---
                if (actName === 'CONVERSE') {
                    if (REGISTRY.REGISTRY_HALT) { return { status: "HALTED", act: "CONVERSE" }; }
                    
                    const userPrompt = actParams.INPUT;
                    
                    // 1. ACT PARSEã®è‡ªå‹•å®Ÿè¡Œ (è‡ªå·±ç›£æŸ»)
                    const parseResult = executeAct('ACT PARSE (SOURCE: CODE, TARGET: CONTEXT)\nEND ACT');
                    if (parseResult.status === 'HALTED') { 
                        REGISTRY.REGISTRY_OUTPUT = "ERROR: CONVERSEã®å‰æã¨ãªã‚‹ACT PARSEãŒåœæ­¢ã—ã¾ã—ãŸã€‚";
                        return { status: "HALTED", act: "CONVERSE", reason: "NESTED_PARSE_HALTED" };
                    }

                    // 2. INPUTã®è§£æã¨CONTEXTã¸ã®è¿½åŠ 
                    REGISTRY.REGISTRY_CONTEXT.push(`USER: ${userPrompt}`);
                    REGISTRY.REGISTRY_INPUT = userPrompt;

                    // 3. å¿œç­”ç”Ÿæˆã®æ±ºå®šè«–çš„ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆLLMã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
                    let response = "";
                    let isCodeGenerated = false;
                    
                    // LLMãƒ­ã‚¸ãƒƒã‚¯ã®ç°¡æ˜“å®Ÿè£…
                    if (userPrompt.includes("MINT")) {
                        const mintCount = COUNT_ACTS($code.value, "MINT");
                        response = `MINTå…¬ç†ã«ã¤ã„ã¦ã€ç¾åœ¨ ${mintCount} ã®å®šç¾©ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚æ–°ã—ã„MINTå…¬ç†ã®è¿½åŠ ã‚’è©¦è¡Œã—ã¾ã™ã€‚`;
                        
                        // ACT GENERATEã‚’å†…éƒ¨å®Ÿè¡Œ
                        const genResult = executeAct('ACT GENERATE (SOURCE: CONTEXT, TARGET: CODE, PROMPT: "æ–°ã—ã„MINTå…¬ç†ã‚’ææ¡ˆ")\nEND ACT');
                        if (genResult.status === 'SUCCESS') {
                            response += " ã‚³ãƒ¼ãƒ‰ãŒè‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚ç¢ºèªã—ã¦ãã ã•ã„ã€‚";
                            isCodeGenerated = true;
                        } else {
                            response += " ã‚³ãƒ¼ãƒ‰ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
                        }
                    } else if (userPrompt.includes("VIBE")) {
                        const vibeFixed = FROM_FIXED(REGISTRY.REGISTRY_VIBE).toFixed(4);
                        response = `ç¾åœ¨ã®VIBEã¯ ${vibeFixed} ã§ã™ã€‚ACT REFLECTã«ã‚ˆã‚Šå¶å¥‡ã§ä¿®æ­£ã•ã‚Œã¦ã„ã¾ã™ã€‚`;
                    } else {
                        response = "ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¦æ±‚ã‚’CONTEXTã«è¿½åŠ ã—ã¾ã—ãŸã€‚å…·ä½“çš„ãªè«–ç†ä½œç‚ºã‚’æŒ‡ç¤ºã—ã¦ãã ã•ã„ã€‚";
                    }

                    REGISTRY.REGISTRY_OUTPUT = response;
                    logAudit('SUCCESS', `CONVERSE: AIãŒå¿œç­”ã‚’ç”Ÿæˆã—ã¾ã—ãŸã€‚(CodeGen: ${isCodeGenerated})`);
                    return { status: "SUCCESS", act: "CONVERSE" };
                }
                
                // --- ğŸ§  ACT PARSE ã®å®Ÿè¡Œ ---
                if (actName === 'PARSE') {
                    // ... (çœç•¥: v5.0ã¨åŒä¸€ãƒ­ã‚¸ãƒƒã‚¯)
                    if (REGISTRY.REGISTRY_HALT) { return { status: "HALTED", act: "PARSE" }; }
                    
                    REGISTRY.REGISTRY_CODE = $code.value;
                    
                    const codeText = REGISTRY.REGISTRY_CODE;
                    const mintCount = COUNT_ACTS(codeText, "MINT");
                    
                    // CONTEXTã‚’ãƒªã‚»ãƒƒãƒˆã—ã€æ–°ã—ã„ç›£æŸ»æƒ…å ±ã‚’å…¥ã‚Œã‚‹
                    REGISTRY.REGISTRY_CONTEXT = [
                        `ç›£æŸ»: MINTå…¬ç†ã¯ ${mintCount} å›å®šç¾©ã•ã‚Œã¦ã„ã¾ã™ã€‚`,
                        `ç›£æŸ»: åœæ­¢æ¡ä»¶ã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ: ${GET_PARAM(codeText, "HALT LOGIC", "CHECK")}`
                    ];
                    
                    if (mintCount === 0) { REGISTRY.REGISTRY_HALT = true; logAudit('HALT', 'PARSE: MINTå…¬ç†ãŒãªã„ãŸã‚ã€è«–ç†ãŒç„¡æ„å‘³ã¨åˆ¤æ–­ã•ã‚Œåœæ­¢ã€‚'); return { status: "HALTED", act: "PARSE" }; }
                    
                    return { status: "SUCCESS", act: "PARSE" };
                }

                // --- âœï¸ ACT GENERATE ã®å®Ÿè¡Œ ---
                if (actName === 'GENERAT') { // GENERATEã¯ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰è¡çªã‚’é¿ã‘ã‚‹ãŸã‚ç°¡æ˜“åã§å®Ÿè£…
                    // ... (çœç•¥: v5.0ã¨åŒä¸€ãƒ­ã‚¸ãƒƒã‚¯)
                    if (REGISTRY.REGISTRY_HALT) { return { status: "HALTED", act: "GENERAT" }; }
                    
                    const prompt = actParams.PROMPT;
                    
                    const newActCode = `
// --- ğŸ¤– AIææ¡ˆ MINT V2 (ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ: ${prompt}) --- 
ACT MINT_V2 (T: USER_A, A: 20.0)
    IF REGISTRY_VIBE > 102.00 THEN CALC_HALT 
    SET REGISTRY_ALPHA[T] = ADD(REGISTRY_ALPHA[T], A)
    SET REGISTRY_VIBE = ADD_VIBE(REGISTRY_VIBE)
END ACT\n\n`;

                    REGISTRY.REGISTRY_CODE = ADD_TO_CODE($code.value, newActCode);
                    $code.value = REGISTRY.REGISTRY_CODE; 
                    
                    REGISTRY.REGISTRY_CONTEXT.push(`ç”Ÿæˆ: AIãŒãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã€Œ${prompt}ã€ã«åŸºã¥ãæ–°ã—ã„ACTã‚’ã‚³ãƒ¼ãƒ‰ã«è¿½åŠ ã—ã¾ã—ãŸã€‚`);

                    logAudit('SUCCESS', 'GENERAT: AIãŒæ–°ã—ã„å…¬ç†ã‚’è«–ç†ç©ºé–“ã«æŒ¿å…¥ã—ã¾ã—ãŸã€‚');

                    return { status: "SUCCESS", act: "GENERAT" };
                }

                // --- ğŸ“ˆ ACT DIVERGENCE, REFLECT, MINT, SWAP, TRANSFER ã®å®Ÿè¡Œ ---
                if (actName === 'DIVERGENCE') { /* ... çœç•¥ ... */ 
                    const conditionResult = evaluateCondition(actParams.CHECK);
                    let executedAct = conditionResult ? actParams.D_ACT : actParams.S_ACT;
                    let result = executeAct(executedAct + '\nEND ACT');

                    if (result.status === 'HALTED') { logAudit('HALT', 'DIVERGENCE: å®Ÿè¡Œã•ã‚ŒãŸACTã«ã‚ˆã‚Šã‚·ã‚¹ãƒ†ãƒ åœæ­¢ã€‚'); return { status: "HALTED", act: "DIVERGENCE", reason: "NESTED_ACT_HALTED" }; }
                    
                    const convergentAct = actParams.C_ACT;
                    result = executeAct(convergentAct + '\nEND ACT');
                    if (result.status === 'HALTED') { logAudit('HALT', 'DIVERGENCE: C_ACTã«ã‚ˆã‚Šã‚·ã‚¹ãƒ†ãƒ åœæ­¢ã€‚'); return { status: "HALTED", act: "DIVERGENCE", reason: "C_ACT_HALTED" }; }
                    
                    return { status: "SUCCESS", act: "DIVERGENCE" };
                }

                if (actName === 'REFLECT') {
                    // ... (çœç•¥: VIBEãƒ­ã‚¸ãƒƒã‚¯)
                    const factor = parseFloat(actParams.FACTOR);
                    const fixedFactor = TO_FIXED(factor);
                    const targetVibe = REGISTRY.REGISTRY_VIBE;
                    if (REGISTRY.REGISTRY_HALT) { return { status: "HALTED", act: "REFLECT" }; }
                    const isEven = REGISTRY.REGISTRY_CYCLE % 2 === 0;
                    const vibeChangeAmount = MUL_FIXED(targetVibe, fixedFactor);
                    if (isEven) { REGISTRY.REGISTRY_VIBE = SUB_FIXED(targetVibe, vibeChangeAmount); } else { REGISTRY.REGISTRY_VIBE = ADD_FIXED(targetVIBE, vibeChangeAmount); }
                    REGISTRY.REGISTRY_CYCLE += 1; 
                    const softCeiling = TO_FIXED(105.00);
                    const softFloor = TO_FIXED(95.00);
                    if (REGISTRY.REGISTRY_VIBE > softCeiling || REGISTRY.REGISTRY_VIBE < softFloor) {
                         REGISTRY.REGISTRY_HALT = true;
                         logAudit('HALT', `REFLECT: VIBE(${FROM_FIXED(REGISTRY.REGISTRY_VIBE).toFixed(4)})ãŒè¨±å®¹ç¯„å›²å¤–(95-105)ã«åˆ°é”ã€‚å¼·åˆ¶åœæ­¢ã€‚`);
                         return { status: "HALTED", act: "REFLECT", reason: "VIBE_OVERSHOOT" };
                    }
                    return { status: "SUCCESS", act: "REFLECT" };
                }

                if (actName === 'MINT') {
                    const target = actParams.T;
                    const amount = parseFloat(actParams.A);
                    const fixedAmount = TO_FIXED(amount);
                    if (REGISTRY.REGISTRY_HALT || REGISTRY.REGISTRY_VIBE > VIBE_CEILING) { REGISTRY.REGISTRY_HALT = true; logAudit('HALT', `MINTå¤±æ•—: VIBEé«˜ã™ãã€‚`); return { status: "HALTED", act: "MINT" }; }
                    REGISTRY.REGISTRY_ALPHA[target] = ADD_FIXED(REGISTRY.REGISTRY_ALPHA[target], fixedAmount);
                    REGISTRY.REGISTRY_VIBE = ADD_FIXED(REGISTRY.REGISTRY_VIBE, VIBE_DELTA_ADD); 
                    logAudit('SUCCESS', `MINT: ${amount}ã‚’${target}ã«ç™ºè¡Œã€‚`);
                    return { status: "SUCCESS", act: "MINT" };
                }
                
                if (actName === 'SWAP') { /* ... çœç•¥ ... */
                    const user = actParams.USER;
                    const fromToken = actParams.FROM;
                    const toToken = actParams.TO;
                    const amount = parseFloat(actParams.AMOUNT);
                    const rate = parseFloat(actParams.RATE);
                    if (REGISTRY.REGISTRY_HALT || fromToken === toToken) { return { status: "HALTED", act: "SWAP" }; }
                    const regFrom = resolveRegistry(fromToken);
                    const regTo = resolveRegistry(toToken);
                    const fixedAmount = TO_FIXED(amount);
                    const fixedRate = TO_FIXED(rate);
                    const fixedReceive = MUL_FIXED(fixedAmount, fixedRate);
                    if (regFrom[user] < fixedAmount) { REGISTRY.REGISTRY_HALT = true; logAudit('HALT', `SWAPå¤±æ•—: æ®‹é«˜ä¸è¶³ã€‚`); return { status: "HALTED", act: "SWAP" }; }
                    regFrom[user] = SUB_FIXED(regFrom[user], fixedAmount);
                    regTo[user] = ADD_FIXED(regTo[user], fixedReceive);
                    REGISTRY.REGISTRY_VIBE = ADD_FIXED(REGISTRY.REGISTRY_VIBE, VIBE_DELTA_SWAP); 
                    if (REGISTRY.REGISTRY_VIBE > VIBE_CEILING) { REGISTRY.REGISTRY_HALT = true; logAudit('HALT', `VIBEé«˜ã™ãã€‚`); return { status: "HALTED", act: "SWAP" }; }
                    return { status: "SUCCESS", act: "SWAP" };
                }


                logAudit('FAIL', `VM: æœªçŸ¥ã®ACTå…¬ç† '${actName}' ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚`);
                return { status: "FAIL", reason: "UNKNOWN_ACT" };
            }


            return {
                init: init,
                executeLogic: function() {
                    const result = executeAct($code.value); 
                    updateUI();
                    return result;
                },
                executeConverse: function() {
                    const prompt = $promptInput.value.trim();
                    if (!prompt) {
                        alert('è³ªå•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                        return;
                    }
                    const converseAct = `ACT CONVERSE (INPUT: "${prompt}", OUTPUT: AI_RESPONSE)`;
                    const result = executeAct(converseAct + '\nEND ACT');
                    updateUI();
                    return result;
                },
                 saveLogic: function() {
                    try {
                        const dataToSave = { code: $code.value, registry: REGISTRY, };
                        localStorage.setItem(STORAGE_KEY, JSON.stringify(dataToSave));
                        logAudit('PERSIST', 'è«–ç†ã®æ°¸ç¶šåŒ– (ACT PERSIST) ãŒå®Œäº†ã—ã¾ã—ãŸã€‚');
                        alert('ğŸ’¾ ACT PERSIST (è«–ç†ã®æ°¸ç¶šåŒ–) ãŒå®Œäº†ã—ã¾ã—ãŸã€‚');
                    } catch (e) {
                        logAudit('HALT', 'ACT PERSIST ã«å¤±æ•—ã€‚');
                        alert('âŒ ACT PERSIST ã«å¤±æ•—ã€‚');
                    }
                    updateUI();
                },
                loadLogic: function() {
                    try {
                        const storedData = localStorage.getItem(STORAGE_KEY);
                        if (storedData) {
                            const data = JSON.parse(storedData);
                            $code.value = data.code;
                            REGISTRY = data.registry; 
                            
                            // æ–°è¦ãƒ¬ã‚¸ã‚¹ãƒˆãƒªã®åˆæœŸåŒ–ãƒã‚§ãƒƒã‚¯
                            REGISTRY.REGISTRY_CODE = REGISTRY.REGISTRY_CODE || "";
                            REGISTRY.REGISTRY_CONTEXT = REGISTRY.REGISTRY_CONTEXT || [];
                            REGISTRY.REGISTRY_INPUT = REGISTRY.REGISTRY_INPUT || "";
                            REGISTRY.REGISTRY_OUTPUT = REGISTRY.REGISTRY_OUTPUT || "AIã¯å¿œç­”ã‚’å¾…ã£ã¦ã„ã¾ã™...";

                            // æ—¢å­˜ãƒ¬ã‚¸ã‚¹ãƒˆãƒªã®åˆæœŸåŒ–
                            REGISTRY.REGISTRY_CYCLE = REGISTRY.REGISTRY_CYCLE || 0;
                            REGISTRY.REGISTRY_VIBE = REGISTRY.REGISTRY_VIBE || TO_FIXED(100.00);
                            REGISTRY.REGISTRY_AUDIT_LOG = REGISTRY.REGISTRY_AUDIT_LOG || [];
                            REGISTRY.REGISTRY_THEOREMS = REGISTRY.REGISTRY_THEOREMS || {}; 
                            REGISTRY.REGISTRY_DEBT = REGISTRY.REGISTRY_DEBT || DEFAULT_REGISTRY.REGISTRY_DEBT;
                            REGISTRY.REGISTRY_BETA = REGISTRY.REGISTRY_BETA || DEFAULT_REGISTRY.REGISTRY_BETA;

                            updateUI();
                            // CalcOS.renderHost(); // åˆå›ãƒ­ãƒ¼ãƒ‰æ™‚ã¯æç”»ã‚’çœç•¥
                            logAudit('RETRIEVE', 'è«–ç†ã®å¾©å…ƒ (ACT RETRIEVE) ã«æˆåŠŸã—ã¾ã—ãŸã€‚');
                            alert('ğŸ“‚ ACT RETRIEVE (è«–ç†ã®å¾©å…ƒ) ã«æˆåŠŸã—ã¾ã—ãŸã€‚');
                        } else {
                            CalcOS.newLogic(true); 
                            logAudit('INFO', 'ä¿å­˜ã•ã‚ŒãŸè«–ç†ãŒã‚ã‚Šã¾ã›ã‚“ã€‚æ•°ç†çš„æ²ˆé»™ã‹ã‚‰èµ·å‹•ã—ã¾ã—ãŸã€‚');
                            alert('ğŸ“‚ ä¿å­˜ã•ã‚ŒãŸè«–ç†ãŒã‚ã‚Šã¾ã›ã‚“ã€‚æ•°ç†çš„æ²ˆé»™ã‹ã‚‰èµ·å‹•ã—ã¾ã—ãŸã€‚');
                        }
                    } catch (e) {
                        logAudit('HALT', 'ACT RETRIEVE ã«å¤±æ•—ã€‚');
                        alert('âŒ ACT RETRIEVE ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                    }
                },
                newLogic: function(silent = false) {
                     if (silent || confirm('ç¾åœ¨ã®è«–ç†ã‚’ç ´æ£„ã—ã€æ•°ç†çš„æ²ˆé»™ã‚’å†ç¢ºç«‹ã—ã¾ã™ã‹ï¼Ÿ')) {
                        $code.value = `// --- ğŸ›‘ è«–ç†ã®åœæ­¢æ¡ä»¶ï¼ˆæ¨©åŠ›æ’é™¤ã®å…¬ç†ï¼‰ ---
ACT HALT LOGIC (CHECK: REGISTRY_ALPHA[USER_A] > 1005.00, REASON: "çµŒæ¸ˆæ´»å‹•ã®æœ‰é™ãªè«–ç†çš„æ¥µé™ã¸ã®åˆ°é”ã€‚æ¨©åŠ›ã®é™æ­¢ã‚’å…¬ç†åŒ–ã€‚")
END ACT

// --- ğŸ“ˆ çµŒæ¸ˆã®æ±ºå®šè«–çš„ä½œç‚ºï¼ˆACT DIVERGENCEï¼‰ ---
ACT DIVERGENCE (CHECK: REGISTRY_ALPHA[USER_A] < 1002.00, D_ACT: MINT (T: USER_A, A: 1.0), S_ACT: ACT SWAP (USER: USER_A, FROM: ALPHA, TO: BETA, AMOUNT: 0.1, RATE: 2.0), C_ACT: ACT REFLECT (TARGET: VIBE, SOURCE: CYCLE, FACTOR: 0.001))
END ACT

// --- ğŸ—£ï¸ ACT CONVERSE (å¯¾è©±å…¬ç† - AIä¸­æ ¸) ---
ACT CONVERSE (INPUT: USER_PROMPT, OUTPUT: AI_RESPONSE)
    IF REGISTRY_HALT == TRUE THEN CALC_HALT
    
    // 1. ACT PARSEã®è‡ªå‹•å®Ÿè¡Œ (ç¾åœ¨ã®è«–ç†ã‚’ç†è§£)
    ACT PARSE (SOURCE: CODE, TARGET: CONTEXT)
    
    // 2. INPUTã®è§£æã¨CONTEXTã¸ã®è¿½åŠ  (å¯¾è©±ã®é–‹å§‹)
    SET REGISTRY_CONTEXT = APPEND(REGISTRY_CONTEXT, "USER: " + USER_PROMPT)
    SET REGISTRY_INPUT = USER_PROMPT // ç°¡æ˜“çš„ãªä¿å­˜

    // 3. å¿œç­”ç”Ÿæˆã®æ±ºå®šè«–çš„ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆLLMã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
    IF CONTAINS(USER_PROMPT, "MINT") THEN
        LET MINT_COUNT = COUNT_ACTS(REGISTRY_CODE, "MINT")
        SET REGISTRY_OUTPUT = "MINTå…¬ç†ã«ã¤ã„ã¦ã€ç¾åœ¨ " + MINT_COUNT + " ã®å®šç¾©ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚è¿½åŠ ã‚’ææ¡ˆã—ã¾ã™ã€‚"
        
        // å¿œç­”å¾Œã€æ¬¡ã®ACT GENERATEã®å®Ÿè¡Œã‚’ææ¡ˆã™ã‚‹
        ACT GENERATE (SOURCE: CONTEXT, TARGET: CODE, PROMPT: "æ–°ã—ã„MINTå…¬ç†ã‚’ææ¡ˆ")
    ELSE IF CONTAINS(USER_PROMPT, "VIBE") THEN
        SET REGISTRY_OUTPUT = "ç¾åœ¨ã®VIBEã¯ " + REGISTRY_VIBE + " ã§ã™ã€‚ACT REFLECTã«ã‚ˆã‚Šå¶å¥‡ã§ä¿®æ­£ã•ã‚Œã¦ã„ã¾ã™ã€‚"
    ELSE
        SET REGISTRY_OUTPUT = "ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¦æ±‚ã‚’CONTEXTã«è¿½åŠ ã—ã¾ã—ãŸã€‚å…·ä½“çš„ãªè«–ç†ä½œç‚ºã‚’æŒ‡ç¤ºã—ã¦ãã ã•ã„ã€‚"
    END IF

    LOG("CONVERSE: å¯¾è©±ã‚µã‚¤ã‚¯ãƒ«ã‚’å®Œäº†ã€‚AIãŒå¿œç­”ã‚’ç”Ÿæˆã—ã¾ã—ãŸã€‚")
END ACT

// --- ğŸ§  ACT PARSE (è«–ç†ã®ç†è§£å…¬ç†) ---
ACT PARSE (SOURCE: CODE, TARGET: CONTEXT)
    IF REGISTRY_HALT == TRUE THEN CALC_HALT
    SET REGISTRY_CODE = CODE_TEXT 
    
    LET MINT_COUNT = COUNT_ACTS(REGISTRY_CODE, "MINT")
    LET HALT_CHECK = GET_PARAM(REGISTRY_CODE, "HALT LOGIC", "CHECK")

    SET REGISTRY_CONTEXT = APPEND(REGISTRY_CONTEXT, "ç›£æŸ»ï¼šMINTå…¬ç†ã¯" + MINT_COUNT + "å›å®šç¾©ã•ã‚Œã¦ã„ã¾ã™ã€‚")
    
    IF MINT_COUNT == 0 THEN CALC_HALT 
END ACT

// --- âœï¸ ACT GENERATE (è«–ç†ã®ç”Ÿæˆå…¬ç†) ---
ACT GENERATE (SOURCE: CONTEXT, TARGET: CODE, PROMPT: "æ–°ã—ã„MINTå…¬ç†ã‚’ææ¡ˆ")
    IF REGISTRY_HALT == TRUE THEN CALC_HALT
    
    // CONTEXTï¼ˆç¾åœ¨ã®ç›£æŸ»çµæœï¼‰ã«åŸºã¥ãã€æ–°ã—ã„ã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã™ã‚‹ãƒ•ãƒƒã‚¯
    LET NEW_ACT = "\n// --- ğŸ¤– AIææ¡ˆ MINT V2 --- \nACT MINT_V2 (T: USER_A, A: 20.0)\n    IF REGISTRY_VIBE > 102.00 THEN CALC_HALT \n    SET REGISTRY_ALPHA[T] = ADD(REGISTRY_ALPHA[T], A)\n    SET REGISTRY_VIBE = ADD_VIBE(REGISTRY_VIBE)\nEND ACT\n"

    SET REGISTRY_CODE = ADD_TO_CODE(REGISTRY_CODE, NEW_ACT)
    
    LOG("GENERATE: AIãŒæ–°ã—ã„å…¬ç†ï¼ˆMINT_V2ï¼‰ã‚’ã‚³ãƒ¼ãƒ‰ã«è¿½åŠ ã—ã¾ã—ãŸã€‚") 
END ACT

// --- ğŸ”® è£œåŠ©å…¬ç†: ACT REFLECT (è‡ªå·±ä¿®æ­£å¾‹ã®å…¬ç†) ---
ACT REFLECT (TARGET: VIBE, SOURCE: CYCLE, FACTOR: 0.001)
    IF REGISTRY_HALT == TRUE THEN CALC_HALT
    IF MOD(REGISTRY_CYCLE, 2) == 0 THEN
        SET REGISTRY_VIBE = SUB(REGISTRY_VIBE, MUL(REGISTRY_VIBE, FACTOR))
    ELSE
        SET REGISTRY_VIBE = ADD(REGISTRY_VIBE, MUL(REGISTRY_VIBE, FACTOR))
    END IF
    SET REGISTRY_CYCLE = ADD(REGISTRY_CYCLE, 1) 
    IF REGISTRY_VIBE > 105.00 OR REGISTRY_VIBE < 95.00 THEN CALC_HALT
END ACT

// --- ğŸ” è£œåŠ©å…¬ç†: ACT SWAP (å¸‚å ´ã®äº¤æ›å¾‹ã®å…¬ç†) ---
ACT SWAP (USER: USER_A, FROM: ALPHA, TO: BETA, AMOUNT: 1.0, RATE: 1.0)
    IF REGISTRY_HALT == TRUE THEN CALC_HALT
    IF FROM == TO THEN CALC_HALT 
    
    LET REGISTRY_FROM = (FROM == ALPHA) ? REGISTRY_ALPHA : REGISTRY_BETA
    LET REGISTRY_TO = (TO == ALPHA) ? REGISTRY_ALPHA : REGISTRY_BETA
    
    LET FIXED_AMOUNT = AMOUNT
    SET REGISTRY_FROM[USER] = SUB(REGISTRY_FROM[USER], FIXED_AMOUNT)
    SET REGISTRY_TO[USER] = ADD(REGISTRY_TO[USER], MUL(FIXED_AMOUNT, RATE))

    SET REGISTRY_VIBE = ADD_VIBE_SMALL(REGISTRY_VIBE) 
    IF REGISTRY_VIBE > 110.00 THEN CALC_HALT
END ACT

// --- ğŸ’° è£œåŠ©å…¬ç†: ACT MINT / ACT TRANSFER ---
ACT MINT (T: USER_A, A: 10.0)
    IF REGISTRY_HALT == TRUE THEN CALC_HALT
    SET REGISTRY_ALPHA[T] = ADD(REGISTRY_ALPHA[T], A)
    SET REGISTRY_VIBE = ADD_VIBE(REGISTRY_VIBE) 
    IF REGISTRY_VIBE > 110.00 THEN CALC_HALT 
END ACT

ACT TRANSFER (S: USER_A, R: USER_B, A: 50.0)
    IF REGISTRY_ALPHA[S] < A THEN CALC_HALT
    SET REGISTRY_ALPHA[S] = SUB(REGISTRY_ALPHA[S], A)
    SET REGISTRY_ALPHA[R] = ADD(REGISTRY_ALPHA[R], A)
    SET REGISTRY_VIBE = SUB_VIBE(REGISTRY_VIBE) 
    IF REGISTRY_VIBE < 90.00 THEN CALC_HALT 
END ACT`;
                        
                        init(); 
                        // CalcOS.renderHost();
                        logAudit('INFO', 'æ•°ç†çš„æ²ˆé»™ãŒå†ç¢ºç«‹ã•ã‚Œã¾ã—ãŸã€‚');
                        if (!silent) alert('ğŸ“„ æ–°è¦ä½œæˆ: æ•°ç†çš„æ²ˆé»™ãŒå†ç¢ºç«‹ã•ã‚Œã¾ã—ãŸã€‚');
                    }
                }
            };
        })();
        
        // --- ç°¡æ˜“VMæ‹¡å¼µæ©Ÿèƒ½ï¼ˆACT PARSE/GENERATEã®ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ï¼‰ ---
        function COUNT_ACTS(code, actName) {
            const regex = new RegExp(`ACT\\s+${actName}(\\s|_|\\()`, 'g');
            return (code.match(regex) || []).length;
        }
        function GET_PARAM(code, actName, paramName) {
            const actBlockMatch = code.match(new RegExp(`ACT\\s+${actName}\\s*\\(([^)]*)\\)[\\s\\S]*?END\\s+ACT`, 's'));
            if (!actBlockMatch) return "ACT_NOT_FOUND";
            const paramsStr = actBlockMatch[1];
            const paramMatch = paramsStr.match(new RegExp(`${paramName}:\\s*(.*?)(?:,|$)`));
            return paramMatch ? paramMatch[1].trim() : "PARAM_NOT_FOUND";
        }
        function ADD_TO_CODE(code, newAct) {
            const haltLogicRegex = /(ACT\s+HALT\s+LOGIC[\s\S]*?END\s+ACT)/;
            // HALT LOGICã®ç›´å‰ã«è¿½åŠ ã™ã‚‹
            if (code.match(haltLogicRegex)) {
                 const newCode = code.replace(haltLogicRegex, newAct + '\n' + code.match(haltLogicRegex)[0]);
                 return newCode;
            }
            return code + '\n' + newAct;
        }
        function CONTAINS(text, subString) {
             return text.includes(subString);
        }
        function APPEND(array, item) {
             const newArray = [...array, item];
             // CONTEXTãŒå¤§ãããªã‚Šã™ããªã„ã‚ˆã†ã«åˆ¶å¾¡
             if (newArray.length > 5) {
                 newArray.shift();
             }
             return newArray;
        }

        
        // åˆæœŸèµ·å‹• (Calc-OSãƒ–ãƒ¼ãƒˆã‚¹ãƒˆãƒ©ãƒƒãƒ—)
        document.addEventListener('DOMContentLoaded', () => {
            CalcOS.init(); 
            CalcOS.loadLogic(); 
        });
    </script>
</body>
</html>
