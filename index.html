<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CalcLang è¨˜è¿°ç’°å¢ƒ (CDE) - æ•°ç†çš„æ²ˆé»™ã®ãƒ¡ãƒ¢å¸³ v2.0</title>
    <style>
        body {
            background-color: #1a1a2e;
            color: #ffffff;
            font-family: 'Consolas', 'Courier New', monospace;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 40px;
        }
        #cde-container {
            width: 800px;
            max-width: 90vw;
            background-color: #2c0b43;
            border: 5px solid #6c4692;
            box-shadow: 0 0 30px rgba(108, 70, 146, 0.5);
            padding: 20px;
            border-radius: 10px;
        }
        textarea {
            width: 100%;
            height: 300px;
            background-color: #0d061c;
            color: #d4d4d4;
            border: 1px solid #4a2f60;
            padding: 15px;
            resize: none;
            font-size: 14px;
            outline: none;
            margin-bottom: 15px; /* ã‚¹ãƒšãƒ¼ã‚¹è¿½åŠ  */
        }
        .status-box {
            margin-top: 20px;
            padding: 10px;
            border-radius: 5px;
            font-weight: bold;
        }
        .status-success { background-color: #216140; }
        .status-halted { background-color: #7d2a2a; }
        .btn {
            padding: 8px 15px;
            background-color: #6c4692;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-right: 10px;
        }
        .btn:hover {
            background-color: #8c5fb2;
        }
        .btn-file { background-color: #4a2f60; }
        .btn-file:hover { background-color: #60467a; }
        .btn-run { background-color: #2c0b43; }
        .btn-run:hover { background-color: #401a60; }

        /* è«–ç†ã®è¦–è¦šåŒ–: æ²ˆé»™ã®å¼·åˆ¶ï¼ˆä»Šå›ã¯ãƒã‚¤ãƒ©ã‚¤ãƒˆã®æº–å‚™ã¨ã—ã¦ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆï¼‰ */
        /* .silent-text { color: #555555; } */
    </style>
</head>
<body>
    <div id="cde-container">
        <h1 style="color: #a47fe0;">CalcLang è¨˜è¿°ç’°å¢ƒ (CDE) Î©Î±</h1>
        <p style="color: #ccc; font-size: small;">
            æ•°ç†çš„æ²ˆé»™ã®åœŸå°ã€‚æ©Ÿèƒ½é¢ã¯Windowsãƒ¡ãƒ¢å¸³ã®é¡åƒã§ã™ã€‚
        </p>

        <div class="status-box" id="halt-status">
            âœ… **ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹:** æ­£å¸¸ç¨¼åƒ
        </div>
        <p><strong>ç¾åœ¨ã® ALPHA æ®‹é«˜:</strong> USER_A: <span id="alpha-balance-a">1000.00</span> | USER_B: <span id="alpha-balance-b">1000.00</span></p>

        <div style="margin-bottom: 15px;">
            <button class="btn btn-file" onclick="saveCalcCode()">ğŸ’¾ è«–ç†ã®ã‚³ãƒŸãƒƒãƒˆ (ä¿å­˜)</button>
            <button class="btn btn-file" onclick="loadCalcCode()">ğŸ“‚ è«–ç†ã®å¾©å…ƒ (é–‹ã)</button>
            <button class="btn btn-file" onclick="newCalcCode()">ğŸ“„ æ–°è¦ä½œæˆ (æ²ˆé»™ã®å†ç¢ºç«‹)</button>
        </div>

        <label for="calc-code" style="display: block; margin-top: 15px;">
            CalcLang è«–ç†è¨˜è¿° (ACTå…¬ç†):
        </label>
        <textarea id="calc-code">
ACT MINT (T: USER_A, A: 10.0)
    // R1: Mintã¯HALTçŠ¶æ…‹ã§å®Ÿè¡Œã§ããªã„
    IF REGISTRY_HALT == TRUE THEN CALC_HALT

    // è«–ç†çš„å®Ÿè¡Œ (SETå…¬ç†ã®é¡åƒ)
    SET REGISTRY_ALPHA[T] = ADD(REGISTRY_ALPHA[T], A)
    SET REGISTRY_CLOCK = ADD(REGISTRY_CLOCK, 1)

END ACT

ACT TRANSFER (S: USER_A, R: USER_B, A: 50.0)
    // R2: é€é‡‘å…ƒã«ååˆ†ãªæ®‹é«˜ãŒã‚ã‚‹ã‹ç›£æŸ»
    IF REGISTRY_ALPHA[S] < A THEN CALC_HALT

    // è«–ç†çš„å®Ÿè¡Œ (äºŒé‡ç°¿è¨˜ã®é¡åƒ)
    SET REGISTRY_ALPHA[S] = SUB(REGISTRY_ALPHA[S], A)
    SET REGISTRY_ALPHA[R] = ADD(REGISTRY_ALPHA[R], A)
    SET REGISTRY_CLOCK = ADD(REGISTRY_CLOCK, 1)

END ACT
        </textarea>

        <button class="btn btn-run" onclick="executeCalcLangCode()">
            â–¶ï¸ ä½œç‚ºã‚’ VM ã§å®Ÿè¡Œ (Audit & Execute)
        </button>
    </div>

    <script>
        const STORAGE_KEY = 'CalcLang_CDE_Logic';
        
        // --- ğŸ§  CalcLang ãƒ¬ã‚¸ã‚¹ãƒˆãƒªã¨ VM ã®åˆæœŸéª¨æ ¼ ---
        let CalcLang_Registry = {
            REGISTRY_ALPHA: {
                "USER_A": 1000.00,
                "USER_B": 1000.00, // æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½åŠ 
            },
            REGISTRY_CLOCK: 0,
            REGISTRY_HALT: false,
        };

        // 3. UI è¦ç´ ã®å‚ç…§
        const $balanceA = document.getElementById('alpha-balance-a');
        const $balanceB = document.getElementById('alpha-balance-b');
        const $status = document.getElementById('halt-status');
        const $code = document.getElementById('calc-code');

        // å››å‰‡æ¼”ç®—ã®é¡åƒ (ãƒ”ã‚¿ã‚´ãƒ©ã‚¹çš„ç´”ç²‹æ€§)
        const ADD = (a, b) => a + b;
        const SUB = (a, b) => a - b;
        const MUL = (a, b) => a * b; // å°†æ¥çš„ã«FIXEDå‹ã«ç½®æ›
        const DIV = (a, b) => a / b;

        // UI æ›´æ–°é–¢æ•°
        function updateUI() {
            $balanceA.textContent = CalcLang_Registry.REGISTRY_ALPHA['USER_A'].toFixed(2);
            $balanceB.textContent = CalcLang_Registry.REGISTRY_ALPHA['USER_B'].toFixed(2);
            
            $status.textContent = CalcLang_Registry.REGISTRY_HALT 
                ? `âŒ ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹: CALC_HALT (è«–ç†çš„é€£ç¶šæ€§ç ´ç¶», Cycle: ${CalcLang_Registry.REGISTRY_CLOCK})`
                : `âœ… ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹: æ­£å¸¸ç¨¼åƒ (Cycle: ${CalcLang_Registry.REGISTRY_CLOCK})`;
            
            $status.className = 'status-box ' + (CalcLang_Registry.REGISTRY_HALT 
                ? 'status-halted' : 'status-success');
        }

        // --- ğŸ’¾ ãƒ•ã‚¡ã‚¤ãƒ«æ©Ÿèƒ½ã®é¡åƒ ---

        function saveCalcCode() {
            // è«–ç†ã®ã‚³ãƒŸãƒƒãƒˆ: å…¬ç†ãƒ†ã‚­ã‚¹ãƒˆã¨ãƒ¬ã‚¸ã‚¹ãƒˆãƒªçŠ¶æ…‹ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¸å¤‰ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦ä¿å­˜
            try {
                const dataToSave = {
                    code: $code.value,
                    registry: CalcLang_Registry,
                };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(dataToSave));
                alert('è«–ç†ã®ã‚³ãƒŸãƒƒãƒˆã«æˆåŠŸã—ã¾ã—ãŸ (ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜)');
            } catch (e) {
                alert('âŒ è«–ç†ã®ã‚³ãƒŸãƒƒãƒˆã«å¤±æ•—: ' + e.message);
            }
        }

        function loadCalcCode() {
            // è«–ç†ã®å¾©å…ƒ: ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰å…¬ç†ãƒ†ã‚­ã‚¹ãƒˆã¨çŠ¶æ…‹ã‚’å¾©å…ƒ
            try {
                const storedData = localStorage.getItem(STORAGE_KEY);
                if (storedData) {
                    const data = JSON.parse(storedData);
                    $code.value = data.code;
                    CalcLang_Registry = data.registry;
                    updateUI();
                    alert('è«–ç†ã®å¾©å…ƒã«æˆåŠŸã—ã¾ã—ãŸã€‚');
                } else {
                    alert('ğŸ“‚ ä¿å­˜ã•ã‚ŒãŸè«–ç†ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚');
                }
            } catch (e) {
                alert('âŒ è«–ç†ã®å¾©å…ƒã«å¤±æ•—: ' + e.message);
            }
        }

        function newCalcCode() {
            // æ²ˆé»™ã®å†ç¢ºç«‹: CDEã‚’åˆæœŸçŠ¶æ…‹ã«æˆ»ã™
            if (confirm('ç¾åœ¨ã®è«–ç†ã‚’ç ´æ£„ã—ã€æ•°ç†çš„æ²ˆé»™ã‚’å†ç¢ºç«‹ã—ã¾ã™ã‹ï¼Ÿ')) {
                $code.value = `ACT MINT (T: USER_A, A: 10.0)\n    // MINTå…¬ç†...\nEND ACT\n\nACT TRANSFER (S: USER_A, R: USER_B, A: 50.0)\n    // TRANSFERå…¬ç†...\nEND ACT`; // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«æˆ»ã™
                CalcLang_Registry = {
                    REGISTRY_ALPHA: { "USER_A": 1000.00, "USER_B": 1000.00 },
                    REGISTRY_CLOCK: 0,
                    REGISTRY_HALT: false,
                };
                updateUI();
                alert('ğŸ“„ æ–°è¦ä½œæˆ: æ•°ç†çš„æ²ˆé»™ãŒå†ç¢ºç«‹ã•ã‚Œã¾ã—ãŸã€‚');
            }
        }

        // --- ğŸ§  CalcLang VM ã®å®Ÿè¡Œã‚¨ãƒ³ã‚¸ãƒ³ ---

        function executeCalcLangAct(actCode) {
            const lines = actCode.split('\n').map(line => line.trim()).filter(line => line && !line.startsWith('//'));
            const codeString = lines.join(' ');
            
            // --- ACT MINT ã®è§£æã¨å®Ÿè¡Œ ---
            let mintMatch = codeString.match(/ACT MINT \(T:\s*(\w+),\s*A:\s*([\d\.]+)\)(.*?)END ACT/);
            if (mintMatch) {
                const target = mintMatch[1];
                const amount = parseFloat(mintMatch[2]);
                const body = mintMatch[3];

                if (body.includes("CALC_HALT") || CalcLang_Registry.REGISTRY_HALT) {
                     CalcLang_Registry.REGISTRY_HALT = true;
                     return { status: "HALTED", reason: "MINT_HALT_TRIGGERED" };
                }
                if (amount <= 0 || isNaN(amount)) return { status: "FAIL", reason: "MINT_NON_POSITIVE" };
                
                // è«–ç†çš„å®Ÿè¡Œ (SETå…¬ç†ã®é¡åƒ)
                CalcLang_Registry.REGISTRY_ALPHA[target] = ADD(CalcLang_Registry.REGISTRY_ALPHA[target], amount);
                CalcLang_Registry.REGISTRY_CLOCK = ADD(CalcLang_Registry.REGISTRY_CLOCK, 1);
                return { status: "SUCCESS", act: "MINT" };
            }
            
            // --- ACT TRANSFER ã®è§£æã¨å®Ÿè¡Œ ---
            let transferMatch = codeString.match(/ACT TRANSFER \(S:\s*(\w+),\s*R:\s*(\w+),\s*A:\s*([\d\.]+)\)(.*?)END ACT/);
            if (transferMatch) {
                const sender = transferMatch[1];
                const receiver = transferMatch[2];
                const amount = parseFloat(transferMatch[3]);
                const body = transferMatch[4];

                if (body.includes("CALC_HALT") || CalcLang_Registry.REGISTRY_HALT) {
                     CalcLang_Registry.REGISTRY_HALT = true;
                     return { status: "HALTED", reason: "TRANSFER_HALT_TRIGGERED" };
                }
                
                // R2: ç›£æŸ»å…¬ç† - æ®‹é«˜ãƒã‚§ãƒƒã‚¯
                if (SUB(CalcLang_Registry.REGISTRY_ALPHA[sender], amount) < 0) {
                     CalcLang_Registry.REGISTRY_HALT = true; // è«–ç†çš„é€£ç¶šæ€§ç ´ç¶»
                     return { status: "HALTED", reason: "TRANSFER_INSUFFICIENT_FUNDS" };
                }
                
                // è«–ç†çš„å®Ÿè¡Œ (äºŒé‡ç°¿è¨˜ã®é¡åƒ)
                CalcLang_Registry.REGISTRY_ALPHA[sender] = SUB(CalcLang_Registry.REGISTRY_ALPHA[sender], amount);
                CalcLang_Registry.REGISTRY_ALPHA[receiver] = ADD(CalcLang_Registry.REGISTRY_ALPHA[receiver], amount);
                CalcLang_Registry.REGISTRY_CLOCK = ADD(CalcLang_Registry.REGISTRY_CLOCK, 1);
                return { status: "SUCCESS", act: "TRANSFER" };
            }

            return { status: "FAIL", reason: "UNKNOWN_ACT_OR_PARSING_ERROR" };
        }

        // å®Ÿè¡Œã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã®ãƒãƒ³ãƒ‰ãƒ©
        function executeCalcLangCode() {
            if (CalcLang_Registry.REGISTRY_HALT) {
                alert("âŒ ã‚·ã‚¹ãƒ†ãƒ ã¯CALC_HALTçŠ¶æ…‹ã§ã™ã€‚æ–°è¦ä½œæˆã§è«–ç†ã‚’å†ç¢ºç«‹ã—ã¦ãã ã•ã„ã€‚");
                return;
            }
            const code = $code.value;
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ä»»æ„ã®ACTã‚’è¨˜è¿°ã§ãã‚‹ãŸã‚ã€å…¨ã‚³ãƒ¼ãƒ‰ã‚’VMã«æ¸¡ã™
            const result = executeCalcLangAct(code); 
            
            console.log(`CalcLang VM Result: ${result.status} (${result.reason || result.act})`);
            
            if (result.status === "SUCCESS" || result.status === "HALTED" || result.status === "FAIL") {
                updateUI();
            }
        }
        
        // åˆæœŸUIæç”»ã¨è«–ç†ã®å¾©å…ƒè©¦è¡Œ
        document.addEventListener('DOMContentLoaded', () => {
            loadCalcCode(); // åˆæœŸèµ·å‹•æ™‚ã«å‰å›ã®è«–ç†ã‚’å¾©å…ƒè©¦è¡Œ
            updateUI();
        });
    </script>
</body>
</html>
